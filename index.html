<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" name="viewport"/>
<meta content="dark light" name="color-scheme"/>
<meta content="#0f172a" name="theme-color"/>
<link href="./manifest.json" rel="manifest"/>
<title>Crypto Run Tracker ‚Äî Binance Futures</title>
<script src="https://cdn.tailwindcss.com"></script>
<link crossorigin="" href="https://s3.tradingview.com" rel="preconnect"/>
<link crossorigin="" href="https://fapi.binance.com" rel="preconnect"/>
<link crossorigin="" href="https://fstream.binance.com" rel="preconnect"/>
<style>
/* Compact OI timeframe buttons (same style, tighter spacing) */
.oi-periods{ display:flex; gap:4px; align-items:center; flex-wrap:nowrap; white-space:nowrap; }
.tools-btn.oi-mini{ padding:.15rem .4rem; font-size:.8rem; line-height:1; min-height:0; border-radius:.4rem; }
@media (max-width: 480px){
  .tools-btn.oi-mini{ padding:.12rem .35rem; font-size:.75rem; }
}

w2px; overflow-y:auto;}

      :root{--bg:#0f172a;--pane:#1f2937;--br:#334155;}
      body{background:radial-gradient(100% 100% at 50% 0%, #1e1b4b 0%, #0f172a 60%, #0f172a 100%);color:#e5e7eb}
      .card{background:rgba(30,41,59,.5);backdrop-filter:blur(6px);border:1px solid #334155;border-radius:1rem}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.55rem 1rem;border-radius:.8rem;border:1px solid #475569;background:rgba(51,65,85,.5);min-height:44px}
      .btn:hover{background:rgba(51,65,85,.8)}
      .pill{padding:.15rem .5rem;border-radius:.5rem;border:1px solid #475569}
      .scroll-area{scrollbar-width:thin;scrollbar-color:#475569 transparent}
      .scroll-area::-webkit-scrollbar{width:8px}.scroll-area::-webkit-scrollbar-thumb{background:#475569;border-radius:8px}
      #tv-container{width:100%;height:560px}@media(max-width:1024px){#tv-container{height:440px}}@media(max-width:640px){#tv-container{height:380px}}
      .tools-btn{font-size:.95rem;padding:.45rem .8rem;border-radius:.6rem;border:1px solid #475569;background:rgba(51,65,85,.5)}
      .tools-btn.active{border-color:#7c3aed;background:rgba(124,58,237,.18)}
          .bar{height:10px;background:rgba(148,163,184,.25);border-radius:4px;overflow:hidden}
      .bar>div{height:100%;background:rgba(124,58,237,.7)}
      td .bar{max-width:100%;}
          .col-right{display:flex;flex-direction:column}
      .col-right>.card:last-child{flex:1;display:flex;flex-direction:column}
      .col-right>.card:last-child>#toolsContent{flex:1;}
    
  /* === Binance Spot sticky panel === */
  .spot-ticker-panel {
    position: fixed;
    top: 16px;
    right: 16px;
    width: clamp(280px, 30vw, 360px);
    max-height: calc(100dvh - 32px);
    display: flex;
    flex-direction: column;
    background: #0b1116;
    color: #e6edf3;
    border: 1px solid #24303a;
    border-radius: 12px;
    box-shadow: 0 15px 40px rgba(0,0,0,.4);
    overflow: hidden;
    transform: translateX(110%);
    opacity: 0;
    pointer-events: none;
    transition: transform .28s cubic-bezier(.2,.8,.2,1), opacity .2s ease;
    z-index: 9999;
  }
  .spot-ticker-panel.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
  .spot-ticker-header {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 10px 12px; background: linear-gradient(180deg, #111a21, #0b1116); border-bottom: 1px solid #24303a;
  }
  .spot-ticker-title { display: flex; flex-direction: column; line-height: 1.15; }
  .spot-ticker-title b { font-size: 14px; letter-spacing: .2px; }
  .spot-ticker-title small { opacity: .7; font-size: 12px; }
  .spot-ticker-close {
    appearance: none; border: none; background: transparent; color: #93a1ad;
    width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: grid; place-items: center;
    font-size: 18px; line-height: 1;
  }
  .spot-ticker-close:hover { background: #0f1720; color: #d7dee6; }
  .spot-ticker-list { overflow: auto; overscroll-behavior: contain; scrollbar-width: thin; scrollbar-color: #2a3945 #0b1116; max-height: calc(100dvh - 56px); }
  .spot-ticker-list ul { list-style: none; margin: 0; padding: 0; }
  .spot-ticker-row {
    display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
    padding: 10px 12px; border-bottom: 1px dashed #1e2933;
  }
  .spot-ticker-row:hover { background: rgba(255,255,255,.02); }
  .sym { font-weight: 600; letter-spacing: .3px; font-variant-numeric: tabular-nums; }
  .pct { font-variant-numeric: tabular-nums; font-weight: 700; }
  .pct.up { color: #00c853; } .pct.down { color: #ff5252; }
  .muted { opacity: .65; }
  .spot-ticker-footer { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 12px;
    border-top: 1px solid #24303a; font-size: 12px; color: #93a1ad; background: #0b1116; }
  .link { color: inherit; text-decoration: underline; text-decoration-color: rgba(255,255,255,.25); }

</style>



<style id="agent-search-timer-style">
  /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç/–∫—É—Ä—Å–æ—Ä/placeholder –≤ –ø–æ–∏—Å–∫–µ –∞–≥–µ–Ω—Ç–∞ */
  #agentSearchInput{ color:#ffffff !important; caret-color:#ffffff !important; }
  #agentSearchInput::placeholder{ color:rgba(255,255,255,.70) !important; }
  /* –§–æ–ª–±—ç–∫–∏ ‚Äî –µ—Å–ª–∏ id –¥—Ä—É–≥–æ–π */
  #agentPanel input[type="text"], #agentPanel input[type="search"]{ color:#ffffff !important; caret-color:#ffffff !important; }
  #agentPanel input::placeholder{ color:rgba(255,255,255,.70) !important; }

  /* –¢–∞–π–º–∏–Ω–≥–∏: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ, –∫–æ–Ω—Ç—É—Ä–Ω—ã–µ, –∞–∫—Ç–∏–≤–Ω–∞—è ‚Äî —è—Ä–∫–∞—è */
  .agent-auto-group{ display:inline-flex; gap:6px; align-items:center; margin-left:auto; }
  .agent-auto-btn{
    min-width:28px; height:22px; padding:0 8px; font-size:11px; line-height:20px;
    border-radius:8px; border:1px solid #7c3aed; background:transparent; color:#cfe0ff;
    box-shadow:none; transition: box-shadow .12s ease, background-color .12s ease, color .12s ease, border-color .12s ease;
  }
  .agent-auto-btn:hover{ box-shadow:0 0 10px rgba(124,58,237,.45); }
  .agent-auto-btn.active{ background:#7c3aed; border-color:#a78bfa; color:#ffffff; box-shadow:0 0 12px rgba(124,58,237,.55); }
  .agent-auto-btn.stop{ border-color:#334155; }
  /* –ü–ª–∞–≤–∞—é—â–∞—è –¥–æ–∫-–ø–∞–Ω–µ–ª—å (—Ñ–æ–ª–±—ç–∫), –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—Ä–æ–∏—Ç—å —Ä—è–¥–æ–º —Å "–ù–∞–π—Ç–∏" */
  #agentAutoDock{
    position:fixed; right:16px; bottom:16px; z-index:9999;
    background:rgba(2,6,23,.75); border:1px solid #334155; backdrop-filter:blur(6px);
    padding:8px; border-radius:12px; display:none;
  }
</style>


<style id="agent-hide-dock">
  #agentAutoDock { display:none !important; }
</style>


<style id="agent-colored-accents">
  #agentOut.agent-long  { border-left:2px solid #22c55e; padding-left:10px; box-shadow: inset 0 0 0 1px rgba(34,197,94,.1); }
  #agentOut.agent-short { border-left:2px solid #ef4444; padding-left:10px; box-shadow: inset 0 0 0 1px rgba(239,68,68,.1); }
</style>

</head>
<body>
<div class="min-h-screen">
<div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
<div class="text-center mb-4 sm:mb-6">
<h1 class="text-2xl sm:text-3xl font-bold">Crypto Run Tracker</h1>
</div>
<div class="card p-3 sm:p-4 mb-4 sm:mb-6">
<div class="flex flex-col lg:flex-row gap-3 items-stretch lg:items-center justify-between">
<div class="relative flex-1 w-full flex gap-2"><div class="flex items-center justify-between gap-3 flex-wrap"><div class="flex items-center gap-2"><button class="tools-btn oi-mini border border-purple-500" id="btn-bybit-futures">–§—å—é—á–µ—Ä—Å—ã Bybit</button><button class="tools-btn oi-mini border border-purple-500" id="btn-binance-spot">–°–ø–æ—Ç Binance</button><button class="tools-btn oi-mini border border-purple-500" id="btn-bybit-spot">–°–ø–æ—Ç Bybit</button><button class="tools-btn oi-mini border border-purple-500" id="" style="display:none;"></button><button class="tools-btn oi-mini border border-purple-500">NATR</button><button class="tools-btn oi-mini border border-purple-500" style="display:none;"></button></div><div class="flex items-center gap-2 ml-auto"><button class="tools-btn oi-mini border border-purple-500" id="marketInfo">–ü–∞—Ä—ã: 501</button></div></div><div class="mt-2 text-xs text-green-400" id="statusBar">WS: ‚Äî</div></div>
<div class="flex items-center gap-2"> <button class="tools-btn oi-mini border border-purple-500" id="togglePricesBtn" type="button">–í–•–û–î</button>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 items-stretch" style="min-height: 720px;">
<div class="lg:col-span-1 card p-4 flex flex-col">
<div class="mb-3">
<h2 class="text-xl font-bold">–¢–æ–ø —Ñ—å—é—á–µ—Ä—Å–æ–≤ (USDT‚ÄëPERP)</h2>
<div class="text-xs text-slate-400" id="filterHint"></div>
</div>
<div class="flex gap-2 mb-3">
<button class="btn flex-1 text-white bg-green-600/80 border-green-700" id="btnGainers" type="button">üìà –†–æ—Å—Ç</button>
<button class="btn flex-1 text-white" id="btnLosers" type="button">üìâ –ü–∞–¥–µ–Ω–∏–µ</button>
</div>
<div class="scroll-area overflow-y-auto" id="screenerList"></div>
<div class="mt-3 hidden rounded-xl border border-slate-700 p-3 bg-slate-900/70 backdrop-blur-md" id="oiFloat">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center gap-2">
<span class="text-slate-300 text-sm">Open Interest</span>
<span class="pill" id="oiF_sym">‚Äî</span>
</div>
<div class="oi-periods">
<button class="tools-btn oi-mini" id="oiP_1m" type="button">1–º</button>
<button class="tools-btn oi-mini active" id="oiP_5m" type="button">5–º</button>
<button class="tools-btn oi-mini" id="oiP_15m" type="button">15–º</button>
</div>
</div>
<div class="grid grid-cols-2 gap-3 font-mono text-sm">
<div>
<div class="text-slate-400 text-xs" id="oiF_buyLbl">Taker Buy (5m)</div>
<div><span class="text-green-400" id="oiF_buy">‚Äî</span> <span class="text-green-300 text-xs" id="oiF_buyPct"> </span></div>
</div>
<div>
<div class="text-slate-400 text-xs" id="oiF_sellLbl">Taker Sell (5m)</div>
<div><span class="text-red-400" id="oiF_sell">‚Äî</span> <span class="text-red-300 text-xs" id="oiF_sellPct"> </span></div>
</div>
<div>
<div class="text-slate-400 text-xs">Open Interest (now)</div>
<div id="oiF_now">‚Äî</div>
</div>
<div>
<div class="text-slate-400 text-xs">Œî OI vs prev</div>
<div id="oiF_delta">‚Äî</div>
</div>
<div class="col-span-2">
<div class="text-slate-400 text-xs">–í—Å–µ–≥–æ (Buy+Sell, 5m)</div>
<div id="oiF_total">‚Äî</div>
</div>
</div>
<div class="text-xs text-slate-400 mt-2" id="oiF_ts">‚Äî</div>
</div>
</div>
<div class="lg:col-span-2 space-y-4 col-right">
<div class="card p-4">
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-full bg-slate-700 grid place-items-center text-white font-bold" id="assetAvatar">‚Äî</div>
<div><h3 class="font-semibold text-lg" id="assetName">‚Äî</h3><p class="text-slate-400 text-sm" id="assetSymbol">‚Äî</p></div>
</div>
<div class="text-right">
<div class="font-mono text-xl" id="assetPrice">‚Ä¶</div>
<div class="text-sm font-semibold" id="assetChange">‚Äî</div>
</div>
</div>
</div>
<div class="card p-0 overflow-hidden"><div id="tv-container"></div></div>
<div class="card">
<div class="sticky top-0 p-2 border-b border-slate-700 bg-slate-900/60 backdrop-blur-sm rounded-t-xl flex gap-2 flex-wrap">
<button class="tools-btn" data-tool="volumes">–û–±—ä—ë–º—ã</button>

</div>
<div class="p-3" id="toolsContent"></div>
</div>
</div>
</div>
</div>
</div>
<script>
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');

      const fmtMoney = (v) => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:v<1?4:2,maximumFractionDigits:v<1?6:2}).format(v);
      const n2=(v)=>Number(v).toFixed(2); const pct=(v)=> isFinite(v)?((v>=0?'+':'')+Number(v).toFixed(2)+'%'):'‚Äî';

      const state = {
        map:{}, list:[], selected:null,
        showPrices:true, screenerView:'gainers', search:'',
        prevVisibleSet:new Set(), wsConnected:false,
        activeTool:'volumes',
        oiPeriod:'5m',
        params:{ signals:{ rsi:14, ma:50, ema:200, macd:{fast:12,slow:26,sig:9}, tfs:['5m','15m','1h','4h'] } }
      };

      const el={
        search:document.getElementById('searchInput'),
        clear:document.getElementById('clearSearch'),
        searchBtn:document.getElementById('searchBtn'),
        toggle:document.getElementById('togglePricesBtn'),
        gainers:document.getElementById('btnGainers'),
        losers:document.getElementById('btnLosers'),
        screener:document.getElementById('screenerList'),
        status:document.getElementById('statusBar'),
        hint:document.getElementById('filterHint'),
        marketInfo:document.getElementById('marketInfo'),
        toolsContent:document.getElementById('toolsContent'),
      };

      function enforceViewportRows(){
        const r = el.screener.querySelector('.row-crypto');
        const h = r ? r.getBoundingClientRect().height : 64;
        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        const rows = isMobile ? 5 : 13;
        el.screener.style.maxHeight = (h*rows) + 'px';
      }

      function renderStatus(){
        const count = state.list.length;
        el.status.innerHTML = `<span class="${state.wsConnected ? "text-green-400" : "text-red-400"}">WS: ${state.wsConnected ? "–ø–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"}</span>`;
        if (el.marketInfo) el.marketInfo.textContent='–ü–∞—Ä—ã: '+(count||'‚Äî');
      }

      let tvWidget=null;
      function ensureTV(cb){
        if (window.TradingView && window.TradingView.widget) return cb();
        if (document.getElementById('tvjs')) return setTimeout(cb,120);
        const s=document.createElement('script'); s.id='tvjs'; s.src='https://s3.tradingview.com/tv.js'; s.onload=cb; document.body.appendChild(s);
      }
      function renderTV(symbol){
        ensureTV(()=>{
          if (!window.TradingView) return;
          if (tvWidget && tvWidget.remove) try{tvWidget.remove();}catch(e){}
          tvWidget = new window.TradingView.widget({
            autosize:true, symbol:'BINANCE:'+symbol+'.P', interval:'60', theme:'dark', style:'1', locale:'en',
            container_id:'tv-container', hide_top_toolbar:false, hide_side_toolbar:false, toolbar_bg:'#0f172a', withdateranges:true, details:true, hotlist:true, calendar:true,
            overrides:{'paneProperties.background':'#0f172a','paneProperties.vertGridProperties.color':'#374151','paneProperties.horzGridProperties.color':'#374151'}
          });
        });
      }

      async function loadMarkets(){
        const ex = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
        const usdt = ex.symbols.filter(s=>s.status==='TRADING' && s.quoteAsset==='USDT' && s.contractType==='PERPETUAL')
          .map(s=>({symbol:s.symbol, base:s.baseAsset, quote:s.quoteAsset, onboard:s.onboardDate}));
        const t = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const mapT=Object.fromEntries(t.map(x=>[x.symbol,x]));
        state.map={}; state.list=[];
        for (const s of usdt){
          const tt=mapT[s.symbol]; if(!tt) continue;
          state.map[s.symbol]={...s, price:+tt.lastPrice, change24h:+tt.priceChangePercent, volumeQuote:+tt.quoteVolume, volumeBase:+tt.volume, high:+tt.highPrice, low:+tt.lowPrice};
          state.list.push(s.symbol);
        }
        state.list.sort((a,b)=> (state.map[b].volumeQuote||0)-(state.map[a].volumeQuote||0));
        state.selected = state.list[0]||'BTCUSDT';
      }

      
// === Funding rates (Binance Futures) ===
let fundingMap = Object.create(null);
let fundingTS = 0;
async function fetchFundingAll(){
  const base = `https://fapi.binance.com/fapi/v1/premiumIndex`;
  const ways = [
    base,
    `https://cors.isomorphic-git.org/${base}`,
    `https://r.jina.ai/http://fapi.binance.com/fapi/v1/premiumIndex`,
    `https://corsproxy.io/?${encodeURIComponent(base)}`
  ];
  let lastErr=null;
  for(const u of ways){
    try{
      const r = await fetch(u,{cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      if(Array.isArray(j)){
        const m = Object.create(null);
        for(const it of j){
          if(!it || !it.symbol) continue;
          const sym = it.symbol;
          let fr = null;
          if (it.lastFundingRate!=null) fr = Number(it.lastFundingRate)*100;
          else if (it.fundingRate!=null) fr = Number(it.fundingRate)*100;
          if (isFinite(fr)) m[sym] = fr;
        }
        fundingMap = m; fundingTS = Date.now();
        return m;
      }
    }catch(e){ lastErr=e; }
  }
  console.warn('Funding fetch failed', lastErr);
  return fundingMap;
}
function fmtFunding(v){
  if (v==null || !isFinite(v)) return '‚Äî';
  const s = (v>=0?'+':'') + v.toFixed(3) + '%';
  return s;
}
async function ensureFundingFresh(){
  const staleMs = 5*60*1000;
  if (Date.now() - fundingTS > staleMs) await fetchFundingAll();
}
setInterval(fetchFundingAll, 5*60*1000);
fetchFundingAll();

function startWS(){
        const ws = new WebSocket('wss://fstream.binance.com/stream?streams=!ticker@arr');
        ws.onopen=()=>{state.wsConnected=true; renderStatus();};
        ws.onmessage=(e)=>{
          const msg=JSON.parse(e.data); const arr=msg && msg.data; if(!Array.isArray(arr)) return;
          for(const t of arr){ const s=t.s; const e=state.map[s]; if(!e) continue; e.price=+t.c; e.change24h=+t.P; e.volumeQuote=+t.q; e.volumeBase=+t.v; }
          renderHeader(); maybeRenderScreener(); if(state.activeTool==='volumes') renderTool('volumes');
        };
        ws.onclose=()=>{state.wsConnected=false; renderStatus(); setTimeout(startWS,1500);};
        ws.onerror=()=>{state.wsConnected=false; renderStatus();};
      }

      function renderHeader(){
        const c=state.map[state.selected]; if(!c) return;
        document.getElementById('assetAvatar').textContent=(c.base||'?').slice(0,3);
        document.getElementById('assetName').textContent=c.base+' PERP';
        document.getElementById('assetSymbol').textContent=c.symbol+' (Futures)';
        document.getElementById('assetPrice').textContent=c.price!=null ? (state.showPrices?fmtMoney(c.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'):'‚Ä¶';
        const ch=Number(c.change24h), elC=document.getElementById('assetChange');
        if(isFinite(ch)){ elC.textContent=`${ch>=0?'+':''}${ch.toFixed(2)}% 24h`; elC.className=`text-sm font-semibold ${ch>=0?'text-green-400':'text-red-400'}`;}
        else { elC.textContent='‚Äî'; elC.className='text-sm font-semibold text-slate-400'; }
      }

      function filteredSymbols(){
        const q=state.search.trim().toLowerCase(); if(!q) return state.list;
        return state.list.filter(sym=>{
          const e=state.map[sym]; return e.symbol.toLowerCase().includes(q) || e.base.toLowerCase().includes(q);
        });
      }
      function screenerOrder(list){
        const entries=list.map(sym=>state.map[sym]).filter(Boolean);
        return (state.screenerView==='gainers') ? entries.sort((a,b)=> (b.change24h)-(a.change24h)) : entries.sort((a,b)=> (a.change24h)-(b.change24h));
      }
      async function renderScreener(){
      // bind gainers/losers buttons once
      if (!window._screenerBtnsBound){
        if (el.gainers) el.gainers.addEventListener('click', ()=>{ state.screenerView='gainers'; if (el.gainers) {el.gainers.classList.add('bg-green-600/80','border-green-700');} if (el.losers) {el.losers.classList.remove('bg-red-600/80','border-red-700');} renderScreener(); });
        if (el.losers) el.losers.addEventListener('click', ()=>{ state.screenerView='losers'; if (el.losers) {el.losers.classList.add('bg-red-600/80','border-red-700');} if (el.gainers) {el.gainers.classList.remove('bg-green-600/80','border-green-700');} renderScreener(); });
        window._screenerBtnsBound = true;
      }

        await ensureFundingFresh(); const q=state.search.trim(); const pool=filteredSymbols(); let entries=screenerOrder(pool); let hint='';
        if(q && pool.length===0){ entries=screenerOrder(state.list); hint=`–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ ‚Äú${q}‚Äù. –ü–æ–∫–∞–∑–∞–Ω –æ–±—â–∏–π —Ç–æ–ø.`; }
        el.hint.textContent=hint;
        const visible=entries.slice(0,13).map(c=>c.symbol); state.prevVisibleSet=new Set(visible);
        const rows=entries.map((c,idx)=>{
          const isSel=c.symbol===state.selected;
          const change=c.change24h, cls=isFinite(change)?(change>=0?'text-green-400':'text-red-400'):'text-slate-400';
          const priceText=c.price!=null?(state.showPrices?fmtMoney(c.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'):'‚Ä¶';
          return `<div class="row-crypto p-3 rounded-lg cursor-pointer transition-all ${isSel?'bg-slate-700 border border-purple-500':'bg-slate-700/30 hover:bg-slate-700/50'}" data-sym="${c.symbol}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 grid place-items-center text-xs font-bold">${c.base.slice(0,3)}</div>
                <div><div class="font-semibold text-sm">${c.base} PERP</div><div class="text-slate-400 text-xs">${c.symbol}</div></div>
              </div>
              <div class="text-right">
                <div class="text-xs opacity-80 mt-0.5">${fmtFunding(fundingMap[c.symbol])}</div>

                <div class="font-mono text-sm">${priceText}</div>
                <div class="text-xs font-semibold ${cls}">${isFinite(change)?(change>=0?'+':'')+change.toFixed(2)+'%':'‚Äî'}</div>
              </div>
            </div></div>`;
        }).join('');
        el.screener.innerHTML = rows || '<div class="text-slate-400 text-sm">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç‚Ä¶</div>';
        el.screener.querySelectorAll('[data-sym]').forEach(n=> n.onclick=()=>{ const s=n.getAttribute('data-sym'); if(state.map[s]){ state.selected=s; renderHeader(); renderTV(s); renderScreener(); renderTool(state.activeTool); OI_updateFloat(s); }});
        enforceViewportRows();
      }
      function maybeRenderScreener(){ renderScreener(); }

      function applySearch(){
        state.search=el.search.value||'';
        const m=filteredSymbols();
        if(state.search.trim() && m.length>0){ const first=m[0]; if(first && first!==state.selected){ state.selected=first; renderHeader(); renderTV(first);} }
        renderScreener(); if(state.activeTool) renderTool(state.activeTool);
      }

      function renderTool(mode){
        if(mode==='volumes') return renderToolVolumes();
        if(mode==='listings') return renderToolListings();
        if(mode==='signals') return renderToolSignals();
        if(mode==='news') return renderToolNews();
      }

      
      
      
  
  
  
  
  
  function renderToolVolumes(){
    const isMobile = window.matchMedia('(max-width: 767px)').matches;

    // ---------- –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (—Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω —Ä–∞–∑) ----------
    let root = document.getElementById('volumesRoot');
    if (!root) {
      el.toolsContent.innerHTML = `
        <div id="volumesRoot">
          <div class="mb-3 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">Futures (Binance) ‚Äî 24—á –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–∏–∫–µ—Ä—É</span>
            <input id="volQ" class="input w-56" style="color:#000;background:#fff" placeholder="BTC / BTCUSDT" autocomplete="off"/>
            <button id="volFind" class="btn" type="button">–ù–∞–π—Ç–∏</button>
            <span id="volErr" class="text-red-400 text-sm" style="display:none"></span>
          </div>
          <div id="volResult" class="mb-4"></div>
<!-- === –°–æ–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ (FORCE) ‚Äî –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ø–æ–∏—Å–∫ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ === -->
<div id="agentPanel" style="border:1px solid #1f2937;background:rgba(15,23,42,.6);border-radius:16px;padding:12px;margin-top:12px;max-width:1024px;margin-left:auto;margin-right:auto;">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <div style="color:#e2e8f0;font-weight:700;">–°–æ–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞</div>
    <input id="agentSearchInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: BTC –∏–ª–∏ BTCUSDT" style="flex:1 1 220px;min-width:220px;border-radius:12px;background:rgba(2,6,23,.5);border:1px solid #334155;padding:8px 12px;color:white;">
    <button id="agentSearchBtn" type="button" onclick="agent_panel_run()" style="background:#0ea5e9;color:white;border-radius:12px;padding:8px 14px;font-weight:600;">–ù–∞–π—Ç–∏</button>
  </div>
  <div id="agentOut" style="color:#94a3b8;font-size:14px;margin-top:8px;">–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.</div>
</div>

          <div class="mb-2 text-slate-300">–†–µ–π—Ç–∏–Ω–≥ –ø–æ 24—á –æ–±—ä—ë–º—É (Futures)</div>
          <div id="volumesTableWrap" class="scroll-area" style="max-height: 396px; overflow-y:auto;"></div>
        </div>
      `;
      root = document.getElementById('volumesRoot');
    }

    const qInput = document.getElementById('volQ');
    const findBtn = document.getElementById('volFind');
    const errLbl  = document.getElementById('volErr');
    const resBox  = document.getElementById('volResult');
    const tableWrap = document.getElementById('volumesTableWrap');

    // ---------- "–ª–∏–ø–∫–æ–µ" –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω–ø—É—Ç–∞ ----------
    // –•—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –≤ state.volumesQuery; –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ–º –ø–æ–ª–µ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–∞—Ö.
    if (typeof state.volumesQuery !== 'string') {
      state.volumesQuery = (state?.map?.[state?.selected]?.symbol) || (state?.map?.[state?.selected]?.base) || '';
    }
    if (qInput.value !== state.volumesQuery) {
      qInput.value = state.volumesQuery;
    }
    qInput.style.setProperty('color','#000','important');
    qInput.addEventListener('input', ()=>{
      state.volumesQuery = qInput.value;
      qInput.style.setProperty('color','#000','important');
    });
    qInput.addEventListener('focus', ()=>{
      qInput.style.setProperty('color','#000','important');
    });
    qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doFind(); } });

    function fmtTs(ts){ try{ return new Date(Number(ts)).toLocaleString(); }catch(_){ return '‚Äî'; } }
    function safe(v, digits=2){ const n=Number(v); return Number.isFinite(n)? n.toFixed(digits):'‚Äî'; }
    function money(v){ const n=Number(v); return Number.isFinite(n)? fmtMoney(n):'‚Äî'; }
    function setErr(msg){ errLbl.textContent = msg || '–¢–∏–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (Futures)'; errLbl.style.display='inline'; }
    function clearErr(){ errLbl.style.display='none'; errLbl.textContent=''; }
    function busy(b){ findBtn.disabled = b; findBtn.setAttribute('aria-busy', b?'true':'false'); }

    async function binanceFetch(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok){
        const txt = await r.text().catch(()=>'');
        const e = new Error('HTTP ' + r.status);
        e.status = r.status; e.body = txt;
        throw e;
      }
      return r.json();
    }

    async function resolveSymbolFutures(q){
      if (state?.map?.[q]) return q;
      const local = state?.list?.find(s => (state.map[s]?.base||'').toUpperCase() === q || s.includes(q));
      if (local) return local;
      try{
        const info = await binanceFetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
        const bySym = info.symbols?.find(s => s.symbol === q);
        if (bySym) return bySym.symbol;
        const byBase = info.symbols?.find(s => s.baseAsset === q && s.quoteAsset === 'USDT');
        if (byBase) return byBase.symbol;
      }catch(_){}
      return null;
    }

    async function fetch24hrFutures(sym){
      return binanceFetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=' + encodeURIComponent(sym));
    }

    async function lookupAndRender(symbolOrBase){
      clearErr();
      resBox.innerHTML = '';

      const raw = (symbolOrBase ?? state.volumesQuery ?? '').trim();
      const q = raw.toUpperCase();
      state.volumesQuery = q; // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
      qInput.value = q;
      qInput.style.setProperty('color','#000','important');
      if(!q){ setErr('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä —Ñ—å—é—á–µ—Ä—Å–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä BTC –∏–ª–∏ BTCUSDT'); return; }

      busy(true);
      try{
        let sym = await resolveSymbolFutures(q);
        if (!sym) throw new Error('–¢–∏–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Binance Futures');
        const data = await fetch24hrFutures(sym);

        // —É—Å–ø–µ—Ö: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤ –ø–æ–ª–µ
        state.volumesQuery = data.symbol || sym;
        qInput.value = state.volumesQuery;
        qInput.style.setProperty('color','#000','important');

        const ch = Number(data.priceChangePercent);
        const chCls = Number.isFinite(ch) ? (ch>=0 ? 'text-green-400' : 'text-red-400') : 'text-slate-400';

        resBox.innerHTML = `
          <div class="rounded-xl border border-slate-700 p-3 bg-slate-800/40">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="pill">${data.symbol || sym}</span>
                <span class="text-slate-400 text-xs">FUTURES</span>
                <span class="text-slate-400 text-sm">24—á —Å–≤–æ–¥–∫–∞</span>
              </div>
              <div class="text-right ${chCls} text-sm font-semibold">
                ${Number.isFinite(ch) ? (ch>=0?'+':'') + ch.toFixed(2) + '%' : '‚Äî'} <span class="ml-2 pill">${Number.isFinite(ch) ? (ch>0?'‚ñ≤ UP': (ch<0?'‚ñº DOWN':'‚ñ¨ FLAT')) : ''}</span>
              </div>
            
            <!-- –ú–∏–Ω–∏-—à–∫–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ 24—á -->
            ${(() => {
                if (!Number.isFinite(ch)) return '';
                const cap = 20; // –¥–∏–∞–ø–∞–∑–æ–Ω ¬±20%
                const mag = Math.min(cap, Math.abs(ch));
                const w = Math.max(2, Math.round((mag / cap) * 100));
                return `
                <div class="mb-3">
                  <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Change (24h) ‚Äî magnitude</div>
                  <div class="bar" style="height:8px;"><div style="width:${w}%;"></div></div>
                  <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>-20%</span><span>0%</span><span>+20%</span>
                  </div>
                </div>`;
            })()}
</div>

            <!-- –°–µ–∫—Ü–∏—è: –¶–µ–Ω—ã -->
            <div class="mb-3">
              <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Prices</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 font-mono text-sm">
                <div><div class="text-slate-400">Last Price</div><div>${safe(data.lastPrice, (Number(data.lastPrice)<1?6:2))}</div></div>
                <div><div class="text-slate-400">Price Change</div><div>${safe(data.priceChange)} (${safe(data.priceChangePercent)}%)</div></div>
                <div><div class="text-slate-400">Weighted Avg</div><div>${safe(data.weightedAvgPrice)}</div></div>
                <div><div class="text-slate-400">High (24h)</div><div>${safe(data.highPrice)}</div></div>
                <div><div class="text-slate-400">Low (24h)</div><div>${safe(data.lowPrice)}</div></div>
                <div><div class="text-slate-400">Open Price</div><div>${safe(data.openPrice)}</div></div>
              </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –û–±—ä—ë–º—ã —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–∞–∫ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ -->
            ${(() => {
                try {
                  const list = (state?.list||[]).map(s => state.map[s]).filter(Boolean);
                  const maxBase = Math.max(...list.map(c => Number(c.volumeBase||0)), 1);
                  const maxQuote = Math.max(...list.map(c => Number(c.volumeQuote||0)), 1);
                  const vb = Number(data.volume||0);
                  const vq = Number(data.quoteVolume||0);
                  const wb = Math.max(2, Math.round((vb/maxBase)*100));
                  const wq = Math.max(2, Math.round((vq/maxQuote)*100));
                  return `
                  <div class="mb-3">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Volumes</div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                      <div>
                        <div class="text-slate-400 text-xs mb-1">–û–±—ä—ë–º (base)</div>
                        <div class="bar"><div style="width:${wb}%"></div></div>
                        <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
                      </div>
                      <div>
                        <div class="text-slate-400 text-xs mb-1">–û–±—ä—ë–º (USDT)</div>
                        <div class="bar"><div style="width:${wq}%"></div></div>
                        <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
                      </div>
                    </div>
                  </div>`;
                } catch(_){ return ''; }
              })()}

            <!-- –°–µ–∫—Ü–∏—è: –í—Ä–µ–º—è –∏ —Ç–æ—Ä–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
            <div class="mb-1">
              <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Times & Activity</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 font-mono text-sm">
                <div><div class="text-slate-400">Open Time</div><div>${fmtTs(data.openTime)}</div></div>
                <div><div class="text-slate-400">Close Time</div><div>${fmtTs(data.closeTime)}</div></div>
                <div><div class="text-slate-400">Trades (count)</div><div>${Number(data.count||0).toLocaleString('en-US')}</div></div>
                <div><div class="text-slate-400">Last Qty</div><div>${safe(data.lastQty)}</div></div>
              </div>
            </div>
          </div>
`;
      }catch(e){
        console.error(e);
        setErr(e?.message || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤–æ —Ñ—å—é—á–µ—Ä—Å–∞—Ö');
      }finally{
        busy(false);
      }
    }

    function doFind(){ lookupAndRender(qInput.value); }
    findBtn.onclick = doFind;

    // ---------- –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫: —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ –æ–±—ä—ë–º–∞–º (–∫–∞–∫ –µ—Å—Ç—å) ----------
    const data = (state?.list||[])
      .map(s => state.map[s])
      .filter(Boolean)
      .sort((a,b)=>(b.volumeQuote||0)-(a.volumeQuote||0))
      .slice(0,200);

    const maxBase = Math.max(...data.map(c=>Number(c.volumeBase||0)), 1);
    const maxQuote = Math.max(...data.map(c=>Number(c.volumeQuote||0)), 1);

    if (isMobile) {
      const cards = data.map((c,i)=>{
        const vb = Number(c.volumeBase||0);
        const vq = Number(c.volumeQuote||0);
        const wb = Math.max(2, Math.round((vb/maxBase)*100));
        const wq = Math.max(2, Math.round((vq/maxQuote)*100));
        const change = Number(c.change24h);
        const chClass = Number.isFinite(change) ? (change>=0?'text-green-400':'text-red-400') : 'text-slate-400';
        const chText = Number.isFinite(change) ? `${change>=0?'+':''}${change.toFixed(2)}%` : '‚Äî';
        return `<div class="rounded-xl border border-slate-700 p-3 mb-3 bg-slate-800/40">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="pill text-xs">${i+1}</span>
              <span class="pill" data-sym="${c.symbol}">${c.symbol}</span>
            </div>
            <div class="text-right ${chClass} text-sm font-semibold">${chText}</div>
          </div>
          <div class="grid grid-cols-1 gap-2">
            <div>
              <div class="text-xs text-slate-400 mb-1">–û–±—ä—ë–º (base)</div>
              <div class="bar"><div style="width:${wb}%"></div></div>
              <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400 mb-1">–û–±—ä—ë–º (USDT)</div>
              <div class="bar"><div style="width:${wq}%"></div></div>
              <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
            </div>
          </div>
        </div>`;
      }).join('');
      tableWrap.innerHTML = cards;
      return;
    }

    // Desktop/Tablet: table view
    const rows = data.map((c,i)=>{
      const vb = Number(c.volumeBase||0);
      const vq = Number(c.volumeQuote||0);
      const wb = Math.max(2, Math.round((vb/maxBase)*100));
      const wq = Math.max(2, Math.round((vq/maxQuote)*100));
      return `<tr class="odd:bg-slate-800/40 even:bg-transparent">
        <td class="px-2 py-2 text-slate-400">${i+1}</td>
        <td class="px-2 py-2"><span class="pill" data-sym="${c.symbol}">${c.symbol}</span></td>
        <td class="px-2 py-2 text-right">
          <div class="bar"><div style="width:${wb}%"></div></div>
          <div>${(vb).toLocaleString('en-US')}</div>
        </td>
        <td class="px-2 py-2 text-right">
          <div class="bar"><div style="width:${wq}%"></div></div>
          <div>${fmtMoney(vq)}</div>
        </td>
        <td class="px-2 py-2 text-right ${c.change24h>=0?'text-green-400':'text-red-400'}">${pct(c.change24h)}</td>
      </tr>`;
    }).join('');

    tableWrap.innerHTML = `
      <table style="table-layout:fixed; width:100%;">
        <colgroup>
          <col style="width:40px;">
          <col style="width:110px;">
          <col style="width:160px;">
          <col style="width:160px;">
          <col style="width:auto;">
        </colgroup>
        <thead style="position:sticky; top:0; background:rgba(15,23,42,.9);">
          <tr>
            <th class="text-left px-2 py-2">#</th>
            <th class="text-left px-2 py-2">–ü–∞—Ä–∞</th>
            <th class="text-right px-2 py-2">–û–±—ä—ë–º (base)</th>
            <th class="text-right px-2 py-2">–û–±—ä—ë–º (USDT)</th>
            <th class="text-right px-2 py-2">–ò–∑–º. 24—á</th>
          </tr>
        </thead>
        <tbody class="font-mono text-sm">
          ${rows}
        </tbody>
      </table>
    `;
  }

          function renderToolListings(){
        el.toolsContent.innerHTML = `
          <div class="mb-2 text-slate-300">–ù–æ–≤—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ USDT‚ÄëPERP (Binance Futures)</div>
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <input id="annQ" class="input w-44" placeholder="–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä., BTC)" />
            <button id="btnAnnByBase" class="btn">–ê–Ω–æ–Ω—Å—ã (–ø–æ –±–∞–∑–µ)</button>
            <button id="btnAnnAll" class="btn">–í—Å–µ –∞–Ω–æ–Ω—Å—ã</button>
          </div>
          <div class="scroll-area" style="max-height: 264px; overflow-y:auto;">
            <table>
              <thead><tr><th>–ü–∞—Ä–∞</th><th>–î–æ–±–∞–≤–ª–µ–Ω</th><th>–ë–∞–∑–∞</th></tr></thead>
              <tbody id="listingsBody"><tr><td colspan="3" class="text-slate-400">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</td></tr></tbody>
            </table>
          </div>`;
        (async()=>{
          try{
            const ex=await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
            const list=(ex.symbols||[]).filter(s=>s.status==='TRADING'&&s.quoteAsset==='USDT'&&s.contractType==='PERPETUAL'&&s.onboardDate).sort((a,b)=>b.onboardDate-a.onboardDate);
            document.getElementById('annQ').value = (state.map[state.selected]?.base)||'';
            document.getElementById('btnAnnByBase').onclick=()=>{
              const q=(document.getElementById('annQ').value||'').trim()||((state.map[state.selected]?.base)||'');
              window.open(`https://www.google.com/search?q=${encodeURIComponent(q+' binance announcement futures perpetual')}`,'_blank','noopener');
            };
            document.getElementById('btnAnnAll').onclick=()=>{
              window.open(`https://www.google.com/search?q=${encodeURIComponent('binance announcement futures perpetual')}`,'_blank','noopener');
            };
            const rows=list.map(s=>`<tr><td><span class="pill">${s.symbol}</span></td><td>${new Date(s.onboardDate).toLocaleString()}</td><td>${s.baseAsset}</td></tr>`).join('');
            document.getElementById('listingsBody').innerHTML = rows || '<tr><td colspan="3" class="text-slate-400">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>';
          }catch(e){ document.getElementById('listingsBody').innerHTML='<tr><td colspan="3" class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; }
        })();
      }

      async function renderToolSignals(){
        const sym=state.selected;
        el.toolsContent.innerHTML = `
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">–°–∏–≥–Ω–∞–ª—ã –¥–ª—è</span>
            <input id="sigSearch" class="input w-44" style="color:#000;background:#fff" value="${sym}" placeholder="BTC / BTCUSDT"/>
            <button id="sigFind" class="btn">–ù–∞–π—Ç–∏</button>
            <span id="sigErr" class="text-red-400 text-sm" style="display:none">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>
          </div>
          <div id="sigTableWrap" class="text-slate-400">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
        (function(){
          const inp=document.getElementById('sigSearch'), btn=document.getElementById('sigFind'), err=document.getElementById('sigErr');
          const clearErr=()=>{err.style.display='none'; inp.style.borderColor='';};
          const doFind=()=>{
            clearErr(); const q=(inp.value||'').trim().toUpperCase(); if(!q) return;
            if(state.map[q]){ state.selected=q; renderHeader(); renderTV(q); renderTool('signals'); renderScreener(); return; }
            const found=state.list.find(s => (state.map[s]?.base||'').toUpperCase()===q || s.includes(q));
            if(found){ state.selected=found; renderHeader(); renderTV(found); renderTool('signals'); renderScreener(); } else { err.style.display='inline'; inp.style.borderColor='#ef4444'; }
          };
          btn.onclick=doFind; inp.onkeypress=(e)=>{ if(e.key==='Enter') doFind(); }; inp.oninput=clearErr;
        })();

        // build table
        const cfg=state.params.signals, tfs=cfg.tfs;
        function sma(a,q){const t=a.slice(-q);return t.reduce((x,y)=>x+y,0)/(t.length||1);}
        function emaSeries(v,k){let e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
        function macdFinal(a,fa,sl,sg){function ser(v,p){const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o;} const ef=ser(a,fa),es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg); return {hist:m.at(-1)-s.at(-1)};}
        function rsi(a,p){let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;} for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;} const rs=g/(l||1e-9); return 100-100/(1+rs);}

        const results=[];
        for(const tf of tfs){
          try{
            const kl=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=300`).then(r=>r.json());
            const closes=kl.map(k=>+k[4]); const last=closes.at(-1); const ma=sma(closes,cfg.ma); const ema=emaSeries(closes,2/(cfg.ema+1)); const macd=macdFinal(closes,cfg.macd.fast,cfg.macd.slow,cfg.macd.sig); const r=rsi(closes,cfg.rsi);
            const trend = last>ma && last>ema ? 'up' : (last<ma && last<ema ? 'down' : 'range');
            results.push({tf,ma,ema,macd,r,trend});
          }catch(e){ results.push({tf,error:true}); }
        }
        const rows=results.map(r=>{
          if(r.error) return `<tr><td>${r.tf}</td><td colspan="4" class="text-red-400">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
          const tr=r.trend==='up'?'<span class="text-green-400">‚Üë –¢—Ä–µ–Ω–¥</span>':(r.trend==='down'?'<span class="text-red-400">‚Üì –¢—Ä–µ–Ω–¥</span>':'<span class="text-slate-400">–§–ª–µ—Ç</span>');
          const mac = r.macd.hist>0?'<span class="text-green-400">MACD+</span>':'<span class="text-red-400">MACD-</span>';
          const rsiTxt = r.r>70?'<span class="text-red-400">RSI 70+</span>':(r.r<30?'<span class="text-green-400">RSI 30-</span>':'<span class="text-slate-400">RSI</span>');
          return `<tr><td>${r.tf}</td><td>${tr}</td><td>${mac}</td><td>${rsiTxt} <span class="text-slate-400">(${n2(r.r)})</span></td><td class="text-right text-slate-400">MA ${n2(r.ma)} / EMA ${n2(r.ema)}</td></tr>`;
        }).join('');
        document.getElementById('sigTableWrap').innerHTML = `<table><thead><tr><th>TF</th><th>Trend MA50/EMA200</th><th>MACD</th><th>RSI(14)</th><th class="text-right">MA –¥–µ—Ç–∞–ª–∏</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      function renderToolNews(){
        const c=state.map[state.selected], base=c?c.base:''; const q=encodeURIComponent(base+' crypto');
        el.toolsContent.innerHTML = `<div class="text-slate-300 mb-3">–ù–æ–≤–æ—Å—Ç–∏ –ø–æ: <strong>${base||state.selected||''}</strong></div>
          <div class="flex flex-wrap gap-2 mb-2">
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:coindesk.com&tbm=nws">CoinDesk</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:cointelegraph.com&tbm=nws">Cointelegraph</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:decrypt.co&tbm=nws">Decrypt</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:binance.com+announcement&tbm=nws">Binance Announcements</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:x.com">X (Twitter)</a>
          </div>`;
      }

      function bindTools(){
        const btns=document.querySelectorAll('.tools-btn');
        btns.forEach(b=>b.onclick=()=>{ btns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.activeTool=b.getAttribute('data-tool'); renderTool(state.activeTool); });
        (btns[0]||{}).classList.add('active');
      }

      (async function init(){
        bindTools(); renderStatus();
        try{ await loadMarkets(); renderHeader(); renderScreener(); renderTV(state.selected); startWS(); renderTool(state.activeTool); }
        catch(e){ el.status.innerHTML='<span class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Binance Futures</span>'; }
      })();

      el.search.onkeypress=(e)=>{ if(e.key==='Enter') applySearch(); };
      el.searchBtn.onclick=applySearch;
      el.clear.onclick=()=>{ el.search.value=''; state.search=''; el.hint.textContent=''; renderScreener(); renderTool(state.activeTool); };
      el.toggle.onclick=()=>{ state.showPrices=!state.showPrices; el.toggle.textContent=state.showPrices?'üôà –°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã':'üëÅ –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—ã'; renderHeader(); renderScreener(); renderTool(state.activeTool); };
      el.gainers.onclick=()=>{ state.screenerView='gainers'; el.gainers.className='btn flex-1 text-white bg-green-600/80 border-green-700'; el.losers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      el.losers.onclick=()=>{ state.screenerView='losers'; el.losers.className='btn flex-1 text-white bg-red-600/80 border-red-700'; el.gainers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      new ResizeObserver(()=>enforceViewportRows()).observe(el.screener);
    </script>
<script>
// ===== Autonomous FORCE Agent with its own search =====

// Network helpers (browser-friendly CORS fallbacks)
async function FA_loadKlines(symbol){
  const base = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=300`;
  const ways = [
    { url: base, tag:'FUTURES' },
    { url: `https://cors.isomorphic-git.org/${base}`, tag:'proxy:isomorphic-git' },
    { url: `https://corsproxy.io/?${encodeURIComponent(base)}`, tag:'proxy:corsproxy.io' },
  ];
  let lastErr=null;
  for(const w of ways){
    try{
      const r = await fetch(w.url,{cache:'no-store'});
      if(!r.ok) throw new Error(`${w.tag}: HTTP ${r.status}`);
      const j = await r.json();
      if(Array.isArray(j)) return { klines:j, source:w.tag };
      throw new Error(`${w.tag}: not array`);
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('no data');
}

async function FA_fetchTickSize(symbol){
  try{
    const r = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo',{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    const s = (j.symbols||[]).find(x=>x.symbol===symbol);
    if(!s) return { tick:0.01, digits:2 };
    const pf = (s.filters||[]).find(f=>f.filterType==='PRICE_FILTER');
    if (pf && pf.tickSize){
      const tick = parseFloat(pf.tickSize);
      const digs = (pf.tickSize.split('.')[1]||'').length;
      return { tick: tick>0?tick:0.01, digits: digs||2 };
    }
    const digits = Number.isFinite(s.pricePrecision)? s.pricePrecision : 2;
    return { tick: 1/Math.pow(10,digits), digits };
  }catch(_){ return { tick:0.01, digits:2 }; }
}
const FA_round=(x,t)=> (!Number.isFinite(t)||t<=0)? x : Math.round(x/t)*t;

// Indicators
const FA_sma=(a,p)=>{const t=a.slice(-p);return t.reduce((x,y)=>x+y,0)/(t.length||1)};
const FA_ema=(a,p)=>{const k=2/(p+1);let e=a[0];for(let i=1;i<a.length;i++)e=a[i]*k+e*(1-k);return e};
function FA_macdHist(a, fa=12, sl=26, sg=9){
  const ser=(v,p)=>{const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o};
  const ef=ser(a,fa), es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg);
  return m.at(-1)-s.at(-1);
}
function FA_rsi(a,p=14){
  if (a.length < p+2) return NaN;
  let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;}
  for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;}
  const rs=g/(l||1e-9); return 100-100/(1+rs);
}
function FA_atr(kl,p=14){
  if (kl.length < p+1) return NaN;
  let trs=[];
  for(let i=1;i<kl.length;i++){
    const hi=+kl[i][2], lo=+kl[i][3], pc=+kl[i-1][4];
    trs.push(Math.max(hi-lo, Math.abs(hi-pc), Math.abs(lo-pc)));
  }
  let avg=0; for(let i=0;i<p;i++) avg+=trs[i]; avg/=p;
  for(let i=p;i<trs.length;i++) avg=(avg*(p-1)+trs[i])/p;
  return avg;
}

// Core agent: always LONG/SHORT + ATR levels + tick-size rounding
async function AGENT_run(symbolRaw){
  const symbol = (symbolRaw || 'BTCUSDT').toUpperCase();
  const { klines, source } = await FA_loadKlines(symbol);
  const closes = klines.map(k=>+k[4]);
  const last   = closes.at(-1);
  const MA50   = closes.length>=50  ? FA_sma(closes,50)  : NaN;
  const EMA200 = closes.length>=200 ? FA_ema(closes,200) : FA_ema(closes, Math.min(200, closes.length-1));
  const MACD_H = FA_macdHist(closes);
  const RSI14  = FA_rsi(closes,14);
  const ATR14  = FA_atr(klines,14);

  let scoreLong=0, scoreShort=0, notes=[];
  if (Number.isFinite(MA50) && Number.isFinite(EMA200)){
    if (last > MA50 && last > EMA200){ scoreLong+=2; notes.push('–¶–µ–Ω–∞ –≤—ã—à–µ MA50 –∏ EMA200'); }
    if (last < MA50 && last < EMA200){ scoreShort+=2; notes.push('–¶–µ–Ω–∞ –Ω–∏–∂–µ MA50 –∏ EMA200'); }
  }
  if (Number.isFinite(MACD_H)){
    if (MACD_H > 0){ scoreLong+=1; notes.push('MACD –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ > 0'); }
    if (MACD_H < 0){ scoreShort+=1; notes.push('MACD –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ < 0'); }
  }
  if (Number.isFinite(RSI14)){
    if (RSI14 > 70){ scoreShort+=1; notes.push('RSI>70 (–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å)'); }
    if (RSI14 < 30){ scoreLong+=1; notes.push('RSI<30 (–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å)'); }
  }

  // Force decision
  let side='NEUTRAL', confidence=0.52;
  if (scoreLong - scoreShort >= 2){ side='LONG'; confidence=0.68; }
  else if (scoreShort - scoreLong >= 2){ side='SHORT'; confidence=0.68; }
  else {
    if (Number.isFinite(EMA200) && Number.isFinite(last)){
      if (last > EMA200){ side='LONG';  confidence = 0.58; }
      else if (last < EMA200){ side='SHORT'; confidence = 0.58; }
    }
    if (side==='NEUTRAL' && Number.isFinite(MACD_H)){
      if (MACD_H > 0){ side='LONG'; confidence = Math.max(confidence, 0.56); }
      else if (MACD_H < 0){ side='SHORT'; confidence = Math.max(confidence, 0.56); }
    }
    if (side==='NEUTRAL' && Number.isFinite(RSI14)){
      if (RSI14 >= 50){ side='LONG';  confidence = Math.max(confidence, 0.54); }
      else { side='SHORT'; confidence = Math.max(confidence, 0.54); }
    }
    if (side==='NEUTRAL'){ side='LONG'; confidence=0.51; }
  }

  // Entry/SL/TP via ATR (RR~2)
  let entry=last, sl=null, tp=null;
  if (Number.isFinite(ATR14) && ATR14>0){
    if (side==='LONG'){ sl=last-1*ATR14; tp=last+2*ATR14; }
    else { sl=last+1*ATR14; tp=last-2*ATR14; }
  }else{
    const pct=0.01;
    if (side==='LONG'){ sl=last*(1-pct); tp=last*(1+2*pct); }
    else { sl=last*(1+pct); tp=last*(1-2*pct); }
  }

  const { tick, digits } = await FA_fetchTickSize(symbol).catch(()=>({tick:0.01,digits:2}));
  const entryR = FA_round(entry, tick);
  const slR    = FA_round(sl, tick);
  const tpR    = FA_round(tp, tick);
  const rr     = Math.abs((tpR-entryR)/(entryR-slR));

  return { symbol, side, confidence, entry:entryR, sl:slR, tp:tpR, rr, notes, source, ATR14, tick, digits };
}

// Render into agent panel
function AGENT_render(res){
  try{
    const outEl = document.getElementById('agentOut');
    if (outEl){
      outEl.classList.remove('agent-long','agent-short');
      outEl.classList.add(res.side==='LONG' ? 'agent-long' : 'agent-short');
    }
  }catch(_){}

  const box = document.getElementById('agentOut');
  if (!box) return;
  const digs = Number.isFinite(res.digits)? res.digits : 6;
  const f = (x)=> Number(x).toLocaleString('ru-RU',{minimumFractionDigits:digs, maximumFractionDigits:digs});
  const color = res.side==='LONG' ? '#22c55e' : '#ef4444';
  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div>
        <span style="border:1px solid ${color};color:${color};padding:2px 10px;border-radius:999px;font-weight:700;">${res.side}</span>
        <span style="color:#94a3b8;margin-left:8px">Conf: ${(res.confidence*100|0)}%</span>
        <span style="color:#94a3b8;margin-left:8px">RR‚âà${res.rr.toFixed(2)}</span>
      </div>
      <div style="color:#94a3b8;font-size:12px;">ATR14‚âà${Number(res.ATR14||0).toFixed(6)} | —Ä–µ–∂–∏–º: —Ñ–æ—Ä—Å-—Ä–µ—à–µ–Ω–∏–µ</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px;font-size:14px;">
      <div><div class="label">–í—Ö–æ–¥</div><div class="value">${f(res.entry)}</div></div>
      <div><div class="label">SL</div><div class="value">${f(res.sl)}</div></div>
      <div><div class="label">TP</div><div class="value">${f(res.tp)}</div></div>
    </div>
    <div style="margin-top:8px;color:#e2e8f0">–ò—Ç–æ–≥: <b>${res.side==='LONG'?'–õ–û–ù–ì':'–®–û–†–¢'}</b>. –í—Ö–æ–¥ –ø–æ —Ä—ã–Ω–∫—É –æ—Ç <b>${f(res.entry)}</b>, SL ‚Äî <b>${f(res.sl)}</b>, TP ‚Äî <b>${f(res.tp)}</b>.</div>
    <div style="margin-top:4px;color:#94a3b8">–ü—Ä–∏—á–∏–Ω—ã: ${(res.notes||[]).join('; ') || '‚Äî'}.</div>
  `;
}

// Wire up local search (robust: global function + event listeners + collapse on empty)
window.agent_panel_run = async function agent_panel_run() {
  const input = document.getElementById('agentSearchInput');
  const out   = document.getElementById('agentOut');
  const btn   = document.getElementById('agentSearchBtn');
  if (!input || !out) return;
  const raw = (input.value||'').trim();
  if (!raw) {
    // collapse to default state
    out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
    if (btn) btn.disabled = true;
    return;
  }
  const sym = (raw.endsWith('USDT') ? raw : raw ? raw+'USDT' : 'BTCUSDT').toUpperCase();
  const pAgent = document.getElementById('agentPanel'); if(pAgent){ const w=pAgent.querySelector('.mob-agent-warn'); if(w) w.remove(); } out.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶';
  if (btn) btn.disabled = true;
  try {
    const res = await AGENT_run(sym);
    AGENT_render(res);
  } catch(e) {
    out.innerHTML = '<span style="color:#f87171">–û—à–∏–±–∫–∞: '+(e.message||e)+'</span>';
  } try{ const pAgent2=document.getElementById('agentPanel'); if(pAgent2){ const w2=pAgent2.querySelector('.mob-agent-warn'); if(w2) w2.remove(); } }catch(_){} finally {
    if (btn) btn.disabled = false;
  }
};

(function attach_agent_panel_listeners(){
  try{
    const input = document.getElementById('agentSearchInput');
    const btn   = document.getElementById('agentSearchBtn');
    const out   = document.getElementById('agentOut');
    if (btn) btn.addEventListener('click', window.agent_panel_run);
    if (input) {
      input.addEventListener('keydown', ev=>{ if (ev.key==='Enter') window.agent_panel_run(); });
      // collapse/restore on input
      input.addEventListener('input', ()=>{
        const val = (input.value||'').trim();
        if (!val) {
          out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
          if (btn) btn.disabled = true;
        } else {
          if (btn) btn.disabled = false;
        }
      });
      // initialize disabled state
      const initVal = (input.value||'').trim();
      if (btn) btn.disabled = !initVal;
      if (!initVal) out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
    }
  }catch(_){}
})();

document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const input = document.getElementById('agentSearchInput');
    const btn   = document.getElementById('agentSearchBtn');
    const out   = document.getElementById('agentOut');
    if (btn && !btn._bound){ btn.addEventListener('click', window.agent_panel_run); btn._bound=true; }
    if (input && !input._bound){
      input.addEventListener('keydown', ev=>{ if (ev.key==='Enter') window.agent_panel_run(); });
      input.addEventListener('input', ()=>{
        const val = (input.value||'').trim();
        if (!val) {
          out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
          if (btn) btn.disabled = true;
        } else {
          if (btn) btn.disabled = false;
        }
      });
      input._bound=true;
      // initialize
      const initVal = (input.value||'').trim();
      if (btn) btn.disabled = !initVal;
      if (!initVal) out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
    }
  }catch(_){
  }
});
</script>
<script>
const OI_FORCE_PROXY = (localStorage.getItem('force_proxy_oi')==='1');
function __wraps(url){
  const arr = [ (u)=>u, (u)=>'https://cors.isomorphic-git.org/'+u, (u)=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u), (u)=>'https://corsproxy.io/?'+encodeURIComponent(u) ];
  return (OI_FORCE_PROXY || location.protocol==='file:') ? arr.slice(1) : arr;
}
async function OI_fetchNow(symbol){
  const base = 'https://fapi.binance.com/fapi/v1/openInterest?symbol='+encodeURIComponent(symbol);
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (j && j.openInterest!=null) return { oi:Number(j.openInterest), time:j.time||Date.now() };
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('OI fetch failed');
}
async function OI_fetchHist(symbol, period='5m', limit=2){
  const base = `https://www.binance.com/futures/data/openInterestHist?symbol=${symbol}&period=${period}&limit=${limit}`;
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (Array.isArray(j)) return j.map(x=>({ t:Number(x.timestamp||x.time||0), oi:Number(x.sumOpenInterest||x.openInterest||x.oi||0) }));
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('OI hist failed');
}
async function OI_fetchTaker(symbol, period='5m', limit=1){
  const base = `https://www.binance.com/futures/data/takerlongshortRatio?symbol=${symbol}&period=${period}&limit=${limit}`;
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (Array.isArray(j) && j.length){
        const it = j[j.length-1];
        return { buy:Number(it.buyVol||it.buy), sell:Number(it.sellVol||it.sell), t:Number(it.timestamp||it.time||0) };
      }
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('taker failed');
}
</script>
<script>
function OI_fmtNum(x){ return Number(x).toLocaleString('en-US',{maximumFractionDigits:0}); }

function OI_setPeriod(p){
  const allowed = new Set(['1m','5m','15m']);
  if(!allowed.has(p)) return;
  state.oiPeriod = p;
  // toggle active class
  [['1m','oiP_1m'],['5m','oiP_5m'],['15m','oiP_15m']].forEach(([val,id])=>{
    const btn = document.getElementById(id);
    if (!btn) return;
    if (val===p) btn.classList.add('active'); else btn.classList.remove('active');
  });
  if (state.selected) OI_updateFloat(state.selected);
}
async function OI_updateFloat(sym){ const period = (state.oiPeriod||'5m');
  const box = document.getElementById('oiFloat');
  const closeBtn = document.getElementById('oiF_close');
  if (closeBtn && !closeBtn._bound) { closeBtn.addEventListener('click', ()=> box.classList.add('hidden')); closeBtn._bound=true; }

  
    const buyLbl = document.getElementById('oiF_buyLbl');
    const sellLbl = document.getElementById('oiF_sellLbl');
    if (buyLbl) buyLbl.textContent = `Taker Buy (${period})`;
    if (sellLbl) sellLbl.textContent = `Taker Sell (${period})`;
    try{
    const [now, hist, taker] = await Promise.allSettled([
      OI_fetchNow(sym), OI_fetchHist(sym,period,50), OI_fetchTaker(sym,period,1)
    ]);
    let oiNow = (now.status==='fulfilled') ? now.value.oi : NaN;
    let oiPrev = NaN;
    if (hist.status==='fulfilled' && Array.isArray(hist.value) && hist.value.length>=2){
      const arr = hist.value;
      const last = arr[arr.length-1].oi;
      const prev = arr[arr.length-2].oi;
      if (!Number.isFinite(oiNow)) oiNow = last;
      oiPrev = prev;
    }
    const buy = taker.status==='fulfilled' ? taker.value.buy : NaN;
    const sell = taker.status==='fulfilled' ? taker.value.sell : NaN;
    const total = (Number.isFinite(buy)?buy:0) + (Number.isFinite(sell)?sell:0);
    const pBuy = total>0 ? (buy/total*100) : NaN;
    const pSell = total>0 ? (sell/total*100) : NaN;
    const dOI = (Number.isFinite(oiNow)&&Number.isFinite(oiPrev)) ? (oiNow-oiPrev) : NaN;
    const dPct = (Number.isFinite(oiNow)&&Number.isFinite(oiPrev) && oiPrev>0) ? (dOI/oiPrev*100) : NaN;
    const ts = (now.status==='fulfilled' && now.value.time) || (taker.status==='fulfilled' && taker.value.t) || Date.now();

    document.getElementById('oiF_sym').textContent = sym;
    document.getElementById('oiF_buy').textContent = Number.isFinite(buy)? OI_fmtNum(buy) : '‚Äî';
    document.getElementById('oiF_sell').textContent = Number.isFinite(sell)? OI_fmtNum(sell) : '‚Äî';
    document.getElementById('oiF_buyPct').textContent  = Number.isFinite(pBuy)? `(${pBuy.toFixed(1)}%)` : '';
    document.getElementById('oiF_sellPct').textContent = Number.isFinite(pSell)? `(${pSell.toFixed(1)}%)` : '';
    document.getElementById('oiF_total').textContent = total>0 ? OI_fmtNum(total) : '‚Äî';
    document.getElementById('oiF_now').textContent = Number.isFinite(oiNow)? OI_fmtNum(oiNow) : '‚Äî';
    const elD = document.getElementById('oiF_delta');
    elD.textContent = Number.isFinite(dOI) ? `${dOI>=0?'+':''}${OI_fmtNum(dOI)} ${Number.isFinite(dPct)?'('+(dPct>=0?'+':'')+dPct.toFixed(2)+'%)':''}` : '‚Äî';
    elD.className = 'font-mono text-sm ' + (Number.isFinite(dOI) ? (dOI>=0?'text-green-400':'text-red-400') : 'text-slate-300');
    document.getElementById('oiF_ts').textContent = new Date(ts).toLocaleString();

    box.classList.remove('hidden');
  }catch(e){
    document.getElementById('oiF_sym').textContent = sym;
    document.getElementById('oiF_buy').textContent = '‚Äî';
    document.getElementById('oiF_sell').textContent = '‚Äî';
    document.getElementById('oiF_buyPct').textContent  = '';
    document.getElementById('oiF_sellPct').textContent = '';
    document.getElementById('oiF_total').textContent = '‚Äî';
    document.getElementById('oiF_now').textContent = '‚Äî';
    document.getElementById('oiF_delta').textContent = '‚Äî';
    document.getElementById('oiF_delta').className = 'font-mono text-sm text-slate-300';
    document.getElementById('oiF_ts').textContent = new Date().toLocaleString();
    box.classList.remove('hidden');
  }
}
</script>
<script>
// Robust sync on click: TV + OI + Agent
document.addEventListener('DOMContentLoaded', ()=>{
  const root = document.getElementById('screenerList');
  if (!root) return;
  root.addEventListener('click', (ev)=>{
    const n = ev.target.closest('[data-sym],[data-symbol]'); if (!n) return;
    const s = n.getAttribute('data-sym') || n.getAttribute('data-symbol'); if (!s) return;
    try{ if (window.renderTV) renderTV(s); }catch(_){}
    try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
    const agIn = document.getElementById('agentSearchInput');
    if (agIn){ agIn.value = s; }
    if (window.agent_panel_run) window.agent_panel_run();
    try{ if (window.state){ window.state.selected = s; if (window.renderHeader) renderHeader(); } }catch(_){}
  }, {passive:true});
});
</script>
<script>
// ---- Runtime '' module (filters + autoscan + heatmap) ----
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.querySelector('[data-tool="signals"]');
  if (btn) btn.textContent = '';
});
const A_sma=(a,p)=>{const t=a.slice(-p);return t.reduce((x,y)=>x+y,0)/(t.length||1)};
function A_atr(kl,p=20){
  if (!kl || kl.length < p+1) return {atr:NaN, trs:[]};
  let trs=[];
  for(let i=1;i<kl.length;i++){
    const hi=+kl[i][2], lo=+kl[i][3], pc=+kl[i-1][4];
    trs.push(Math.max(hi-lo, Math.abs(hi-pc), Math.abs(lo-pc)));
  }
  let avg=0; for(let i=0;i<p;i++) avg+=trs[i]; avg/=p;
  for(let i=p;i<trs.length;i++) avg=(avg*(p-1)+trs[i])/p;
  return {atr:avg, trs};
}
async function A_fetch24hr(){
  const base = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
  const ways=[base, 'https://cors.isomorphic-git.org/'+base, 'https://corsproxy.io/?'+encodeURIComponent(base)];
  for(const u of ways){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const j=await r.json(); if(Array.isArray(j)) return j; }catch(_){}
  } throw new Error('24hr unavailable');
}
async function A_fetchKlines(symbol, interval, limit=288){
  const base = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const ways=[base, `https://isomorphic-git.org/cors/${base}`, `https://cors.isomorphic-git.org/${base}`, `https://corsproxy.io/?${encodeURIComponent(base)}`];
  for(const u of ways){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const j=await r.json(); if(Array.isArray(j)) return j; }catch(_){}
  } throw new Error('klines unavailable '+symbol);
}
function A_scanAnoms(kl){
  const rows = kl.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4], v:+k[5]}));
  const vols=rows.map(r=>r.v);
  const {atr:ATR, trs} = A_atr(kl,20);
  const volAvg = A_sma(vols,20);
  let best=null, score=0, flagsBest=null;
  for(let i=1;i<rows.length;i++){
    const r=rows[i], p=rows[i-1];
    const chg = (r.c - p.c)/p.c * 100;
    const tr  = trs[i-1] || 0;
    const fchg = Math.abs(chg) >= 3;
    const fvol = r.v >= 3*volAvg;
    const fatr = Number.isFinite(ATR) && ATR>0 && tr >= 2*ATR;
    if (fchg || fvol || fatr){
      const s = (fvol?1.2:0) + (fatr?1.0:0) + (fchg?0.8:0);
      if (!best || r.t > best.time){
        best = { time:r.t, change:chg, range:(r.h-r.l)/p.c*100, volume:r.v };
        flagsBest = { fchg, fvol, fatr, note: [
          fchg ? `Œî ${chg.toFixed(2)}%` : null,
          fvol ? `V √ó${(r.v/volAvg).toFixed(1)}` : null,
          fatr ? `ATR √ó${(tr/ATR).toFixed(1)}` : null,
        ].filter(Boolean).join(' ¬∑ ') };
      }
      score = Math.max(score, s);
    }
  }
  if (!best) return null;
  return { ...best, ...flagsBest, score };
}
function openAllHook(scope){
  scope.querySelectorAll('[data-open]').forEach(b=>{
    b.onclick = ()=>{
      const s = b.getAttribute('data-open');
      try{ if (window.renderTV) renderTV(s); }catch(_){}
      try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
      const agIn=document.getElementById('agentSearchInput'); if (agIn){ agIn.value=s; }
      if (window.agent_panel_run) window.agent_panel_run();
      if (window.state){ state.selected=s; if (window.renderHeader) renderHeader(); }
    };
  });
}
const badgeUpdate = (n)=>{
  const btn = document.querySelector('[data-tool="signals"]');
  if (btn) btn.textContent = ` (${n})`;
};
function heat(score){
  const x = Math.max(0, Math.min(1, score/3));
  const a = 0.12 + 0.28*x;
  const h = 210*(1-x);
  return `hsla(${h}, 90%, 40%, ${a})`;
}

window.renderToolSignals = async function renderToolSignals(){
  const elTools = document.getElementById('toolsContent') || (window.el && window.el.toolsContent);
  if (!elTools) return;
  elTools.innerHTML = `
    <div class="mb-2 flex flex-wrap items-center gap-3">
      <span class="text-slate-300"> (24—á)</span>
      <label class="text-slate-400 text-sm">TF:
        <select id="anomTF" class="input w-24" style="color:#000;background:#fff">
          <option value="5m" selected>5m</option>
          <option value="15m">15m</option>
        </select>
      </label>
      <label class="text-slate-400 text-sm">–¢–æ–ø:
        <select id="anomN" class="input w-24" style="color:#000;background:#fff">
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="50">50</option>
        </select>
      </label>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-400">–§–∏–ª—å—Ç—Ä:</span>
        <label class="flex items-center gap-1"><input id="fChg" type="checkbox" checked> Œî%</label>
        <label class="flex items-center gap-1"><input id="fVol" type="checkbox" checked> –û–±—ä—ë–º</label>
        <label class="flex items-center gap-1"><input id="fAtr" type="checkbox" checked> ATR</label>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-400">–ê–≤—Ç–æ:</span>
        <select id="anomAuto" class="input w-28" style="color:#000;background:#fff">
          <option value="0" selected>–í—ã–∫–ª</option>
          <option value="5">–∫–∞–∂–¥—ã–µ 5–º</option>
          <option value="10">–∫–∞–∂–¥—ã–µ 10–º</option>
        </select>
      </div>
      <button id="anomScan" class="btn" type="button">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div id="anomListWrap" class="text-slate-400" style="overflow-y:auto; overflow-y:auto; border:1px solid #1f2937; border-radius:12px;"></div>`;

  let timer=null, lastResults=[];
  let sortKey = 'score', sortDir = -1;

  function setViewportTo10Rows(){
    const wrap = document.getElementById('anomListWrap');
    const firstRow = wrap.querySelector('tbody tr');
    const thead = wrap.querySelector('thead');
    if (!firstRow) return;
    const rh = firstRow.getBoundingClientRect().height || 40;
    const hh = thead ? (thead.getBoundingClientRect().height||28) : 28;
    wrap.style.maxHeight = Math.round(rh*10 + hh + 10) + 'px';
  }

  function renderTable(list){
    const fChg = document.getElementById('fChg').checked;
    const fVol = document.getElementById('fVol').checked;
    const fAtr = document.getElementById('fAtr').checked;
    let results = list.filter(it => (fChg && it.fchg) || (fVol && it.fvol) || (fAtr && it.fatr));

    const get = (it)=>{
      if (sortKey==='symbol') return it.symbol;
      if (sortKey==='time') return it.time;
      if (sortKey==='change') return it.change;
      if (sortKey==='range') return it.range;
      if (sortKey==='volume') return it.volume;
      return it.score;
    };
    results = results.slice().sort((a,b)=>{
      const A = get(a), B = get(b);
      if (A<B) return -1*sortDir;
      if (A>B) return  1*sortDir;
      return (b.time - a.time);
    });

    const rows = results.map((it,i)=>{
      const dt = new Date(it.time).toLocaleString('ru-RU');
      const dirArrow = it.change>=0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
      const bg = heat(it.score);
      return `<tr >
        <td class="text-slate-300">${i+1}</td>
        <td class="text-slate-100 font-medium">${it.symbol}</td>
        <td class="text-slate-200">${dt}</td>
        <td class="text-slate-200">${dirArrow} ${it.change.toFixed(2)}%</td>
        <td class="text-slate-200">${it.range.toFixed(2)}%</td>
        <td class="text-slate-200">${Number(it.volume).toLocaleString('ru-RU')}</td>
        <td class="text-slate-100">${it.note}</td>
        <td><button class="btn btn-xs" data-open="${it.symbol}">–û—Ç–∫—Ä—ã—Ç—å</button></td>
      </tr>`;
    }).join('');

    const wrap = document.getElementById('anomListWrap');
    wrap.innerHTML = `<table class="w-full text-sm">
      <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
        <tr>
          <th data-sort="rank"   class="cursor-pointer">#</th>
          <th data-sort="symbol" class="cursor-pointer">–¢–∏–∫–µ—Ä</th>
          <th data-sort="time"   class="cursor-pointer">–í—Ä–µ–º—è</th>
          <th data-sort="change" class="cursor-pointer">Œî%</th>
          <th data-sort="range"  class="cursor-pointer">–î–∏–∞–ø–∞–∑–æ–Ω%</th>
          <th data-sort="volume" class="cursor-pointer">–û–±—ä—ë–º</th>
          <th>–§–∞–∫—Ç–æ—Ä—ã</th><th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;

    wrap.querySelectorAll('th[data-sort]').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-sort');
        if (k==='rank'){ sortKey='score'; sortDir=-1; }
        else { sortKey=k; sortDir = (sortKey===k) ? -sortDir : -1; }
        renderTable(results);
      };
    });

    document.querySelectorAll('[data-open]').forEach(b=>{
      b.onclick = ()=>{
        const s=b.getAttribute('data-open');
        try{ if (window.renderTV) renderTV(s); }catch(_){}
        try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
        const agIn=document.getElementById('agentSearchInput'); if (agIn){ agIn.value=s; }
        if (window.agent_panel_run) window.agent_panel_run();
        if (window.state){ state.selected=s; if (window.renderHeader) renderHeader(); }
      };
    });

    badgeUpdate(results.length);
    setViewportTo10Rows();
    window.addEventListener('resize', setViewportTo10Rows, {passive:true});
  }

  async function scanMarket(){
    const tf = document.getElementById('anomTF').value || '5m';
    const N  = parseInt(document.getElementById('anomN').value || '30',10);
    const wrap = document.getElementById('anomListWrap');
    wrap.textContent = '–°–∫–∞–Ω–∏—Ä—É—é —Ä—ã–Ω–æ–∫‚Ä¶';
    try{
      const all = await A_fetch24hr();
      let symbols = all
        .filter(x => x.symbol && x.symbol.endsWith('USDT') && !/UPUSDT|DOWNUSDT|BULL|BEAR|[0-9]SUSDT|[0-9]LUSDT/.test(x.symbol))
        .sort((a,b)=> (+b.quoteVolume) - (+a.quoteVolume))
        .slice(0, N)
        .map(x=>x.symbol);
      if (window.state && Array.isArray(state.list) && state.list.length){
        const set = new Set(symbols);
        const ordered = state.list.filter(s => set.has(s)).slice(0,N);
        if (ordered.length) symbols = ordered;
      }
      const limit = tf==='5m' ? 288 : 200;
      const pool = 5;
      let i=0, results=[];
      async function worker(){
        while(i < symbols.length){
          const s = symbols[i++];
          try{
            const kl = await A_fetchKlines(s, tf, limit);
            const ev = A_scanAnoms(kl);
            if (ev) results.push({ symbol:s, ...ev });
          }catch(_){}
        }
      }
      await Promise.all(Array.from({length:pool}, worker));
      results.sort((a,b)=> (b.score - a.score) || (b.time - a.time));
      renderTable(results);
    }catch(e){
      document.getElementById('anomListWrap').innerHTML = '<span class="text-red-400">–û—à–∏–±–∫–∞: '+(e.message||e)+'</span>';
    }
  }

  document.getElementById('anomScan').onclick = scanMarket;
  ['fChg','fVol','fAtr'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=> scanMarket());
  });
  function applyAuto(){
    if (window._anomTimer) { clearInterval(window._anomTimer); window._anomTimer=null; }
    const mins = parseInt(document.getElementById('anomAuto').value,10);
    if (mins>0){
      window._anomTimer = setInterval(scanMarket, mins*60*1000);
    }
  }
  document.getElementById('anomAuto').addEventListener('change', applyAuto);
  scanMarket();
  applyAuto();
};
</script>
<script>
// ==== Unified appSelectSymbol(s) ‚Äî –æ–¥–∏–Ω –≤—Ö–æ–¥ –¥–ª—è TV + OI + –ê–≥–µ–Ω—Ç ====
(function(){
  // –æ—Ç–º–µ–Ω–∞/–¥–µ–±–∞—É–Ω—Å –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤
  let oiTimer = null;
  window.appSelectSymbol = function(symbolRaw){
    if (!symbolRaw) return;
    let s = (''+symbolRaw).trim().toUpperCase();
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';

    // –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ/—Ö–µ–¥–µ—Ä
    try { if (window.state){ state.selected = s; if (window.renderHeader) renderHeader(); } } catch(_){}

    // –≥—Ä–∞—Ñ–∏–∫
    try { if (window.renderTV) renderTV(s); } catch(_){}

    // OI ‚Äî –ª—ë–≥–∫–∏–π –¥–µ–±–∞—É–Ω—Å, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞—Ç—å API –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –¥–≤–æ–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
    if (oiTimer) clearTimeout(oiTimer);
    oiTimer = setTimeout(()=>{
      try { if (window.OI_updateFloat) OI_updateFloat(s); } catch(_){}
    }, 50);

    // –∞–≥–µ–Ω—Ç
    try {
      const agIn = document.getElementById('agentSearchInput');
      if (agIn){ agIn.value = s; }
      if (window.agent_panel_run) window.agent_panel_run();
    } catch(_){}
  };
})();
</script>
<script>
// Screener/Top ‚Üí appSelectSymbol (–Ω–∞–¥—ë–∂–Ω—ã–π –¥–µ–ª–µ–≥–∞—Ç)
document.addEventListener('DOMContentLoaded', ()=>{
  const root = document.getElementById('screenerList');
  if (!root) return;
  root.addEventListener('click', (ev)=>{
    const n = ev.target.closest('[data-sym],[data-symbol]');
    if (!n) return;
    const s = n.getAttribute('data-sym') || n.getAttribute('data-symbol');
    if (s && window.appSelectSymbol) appSelectSymbol(s);
  }, {passive:true});
});
</script>
<script>
// –í–µ—Ä—Ö–Ω–∏–π –ø–æ–∏—Å–∫ ‚Üí appSelectSymbol; –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–æ–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è)
(function(){
  function findInputs(){
    const set = new Set();
    const sels = [
      '#globalSearch', '#searchInput', '#pairSearch', '#searchTop',
      'header input[type="search"]', 'input[type="search"]',
      'input[placeholder*="BTC"]', 'input[placeholder*="–ù–∞–π—Ç–∏"]', 'input[placeholder*="–ü–æ–∏—Å–∫"]'
    ];
    sels.forEach(sel => document.querySelectorAll(sel).forEach(el => set.add(el)));
    return Array.from(set);
  }
  function findButtons(inp){
    const res=[];
    const parent = (inp && inp.closest('form,div,section,header')) || document.body;
    parent.querySelectorAll('button, input[type="submit"]').forEach(b=>{
      const t = (b.value || b.textContent || '').trim();
      if (/^(–ù–∞–π—Ç–∏|Search)$/i.test(t)) res.push(b);
    });
    return res;
  }
  function submit(val){
    const q = (val||'').trim();
    if (!q){
      try{ if (window.agent_panel_collapse) agent_panel_collapse(); }catch(_){}
      return;
    }
    if (window.appSelectSymbol) appSelectSymbol(q);
  }
  function wireOne(inp){
    if (!inp || inp.dataset.wiredTopSearch) return;
    inp.dataset.wiredTopSearch = '1';
    // —á–∏—Ç–∞–µ–º—ã–π –∏–Ω–ø—É—Ç
    inp.style.color='#000'; if (!inp.style.background) inp.style.background='#fff';
    inp.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); submit(inp.value); }});
    inp.addEventListener('input', ()=>{
      if (!inp.value.trim()){
        try{ if (window.agent_panel_collapse) agent_panel_collapse(); }catch(_){}
      }
    });
    findButtons(inp).forEach(btn=>{
      if (!btn.dataset.wiredTopSearch){
        btn.dataset.wiredTopSearch='1';
        btn.addEventListener('click', (e)=>{ e.preventDefault(); submit(inp.value); });
      }
    });
  }
  function wireAll(){ findInputs().forEach(wireOne); }
  document.addEventListener('DOMContentLoaded', wireAll);
  let i=0, t=setInterval(()=>{ wireAll(); if (++i>20) clearInterval(t); }, 300);
})();
</script>
<script>
// : –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª ‚Üí appSelectSymbol
document.addEventListener('DOMContentLoaded', ()=>{
  const wrap = document.getElementById('anomListWrap');
  if (!wrap) return;
  wrap.addEventListener('click', (ev)=>{
    const b = ev.target.closest('[data-open]');
    if (!b) return;
    const s = b.getAttribute('data-open');
    if (s && window.appSelectSymbol) appSelectSymbol(s);
  });
});
</script>
<script>
// Top search direct hook ‚Üí appSelectSymbol
document.addEventListener('DOMContentLoaded', ()=>{
  const ids = ['globalSearch','searchInput','pairSearch','searchTop'];
  ids.forEach(id=>{
    const inp = document.getElementById(id);
    if (!inp || inp.dataset.topHooked) return;
    inp.dataset.topHooked='1';
    inp.style.color='#000'; if (!inp.style.background) inp.style.background='#fff';
    const submit = ()=>{ const v = (inp.value||'').trim(); if (v && window.appSelectSymbol) appSelectSymbol(v); };
    inp.addEventListener('keydown', e=>{ if (e.key==='Enter'){ e.preventDefault(); submit(); }});
  });
});
</script>
<script>
// === FORCE Volumes Clickability (works even with dynamic render) ===
(function(){
  function normalize(sym){
    if (!sym) return null;
    let s = (''+sym).trim().toUpperCase();
    s = s.replace(/\s+/g,'');
    s = s.replace('/', ''); // BTC/USDT -> BTCUSDT
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';
    s = s.replace(/[^A-Z0-9]/g,'');
    if (!/^[A-Z0-9]{3,}$/.test(s)) return null;
    return s;
  }
  function findSymFromNode(node){
    if (!node) return null;
    let cur = node;
    for (let i=0;i<5 && cur;i++){
      if (cur.getAttribute){
        const s = cur.getAttribute('data-sym') || cur.getAttribute('data-symbol') || cur.getAttribute('data-ticker');
        if (s) return normalize(s);
      }
      cur = cur.parentElement;
    }
    const row = node.closest('tr, .row, .item, li, div');
    const txt = (row ? row.innerText : node.innerText) || '';
    const pats = [/([A-Z0-9]{2,})\s*\/\s*USDT/, /([A-Z0-9]{2,})USDT/, /\b([A-Z]{2,10})\b/];
    for (const rx of pats){
      const m = txt.toUpperCase().match(rx);
      if (m && m[1]){
        const sym = normalize(m[1] + (m[0].includes('USDT') ? '' : 'USDT'));
        if (sym) return sym;
      }
    }
    return null;
  }
  function inVolumesSection(node){
    const sec = node.closest('#volumesList, #volumeList, #volumesTable, #volumeTable, [data-tool=\"volumes\"], [data-panel=\"volumes\"], .volumes');
    if (sec) return sec;
    const box = node.closest('section,div,table');
    if (!box) return null;
    const head = (box.querySelector('h2,h3,h4,.title,.header')||{}).textContent || '';
    if (/–æ–±—ä[e—ë]–º/i.test(head)) return box;
    return null;
  }
  function handleClick(ev){
    const sec = inVolumesSection(ev.target);
    if (!sec) return;
    const sym = findSymFromNode(ev.target);
    if (!sym) return;
    ev.preventDefault();
    if (window.appSelectSymbol) appSelectSymbol(sym);
  }
  document.addEventListener('click', handleClick, {passive:false});
  const css = document.createElement('style');
  css.textContent = `
    #volumesList [data-sym], #volumesList [data-symbol], #volumesList [data-ticker],
    #volumeList [data-sym], #volumeList [data-symbol], #volumeList [data-ticker],
    #volumesTable [data-sym], #volumesTable [data-symbol], #volumesTable [data-ticker],
    #volumeTable [data-sym], #volumeTable [data-symbol], #volumeTable [data-ticker],
    [data-tool="volumes"] [data-sym], [data-tool="volumes"] [data-symbol], [data-tool="volumes"] [data-ticker],
    .volumes [data-sym], .volumes [data-symbol], .volumes [data-ticker] { cursor: pointer; text-decoration: none; }
  `;
  document.head.appendChild(css);
})();
</script>
<script>
// --- Volumes table: make ONLY the ticker cell clickable (robust) ---
(function(){
  function normalize(sym){
    if (!sym) return null;
    let s = (''+sym).trim().toUpperCase();
    s = s.replace(/\s+/g,'');
    s = s.replace('/', '');
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';
    s = s.replace(/[^A-Z0-9]/g,'');
    return s;
  }
  function markTickersInVolumes(root){
    if (!root) return;
    // find tables that have header "–ü–∞—Ä–∞"
    const tables = Array.from(root.querySelectorAll('table')).filter(tb=>{
      const ths = Array.from(tb.querySelectorAll('thead th')).map(th=>(th.textContent||'').trim());
      return ths.some(t=>/^–ø–∞—Ä–∞$/i.test(t)) && ths.some(t=>/–æ–±—ä.?–º/i.test(t));
    });
    tables.forEach(tb=>{
      const rows = tb.querySelectorAll('tbody tr');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if (tds.length < 2) return;
        const cell = tds[1]; // –∫–æ–ª–æ–Ω–∫–∞ "–ü–∞—Ä–∞"
        const text = (cell.textContent||'').trim();
        const sym = normalize(text);
        if (!sym) return;
        cell.dataset.ticker = sym;
        cell.classList.add('volumes-ticker');
        if (!cell.dataset.clickWired){
          cell.dataset.clickWired = '1';
          cell.style.cursor = 'pointer';
          cell.addEventListener('click', (e)=>{
            e.preventDefault();
            if (window.appSelectSymbol) appSelectSymbol(sym);
          });
        }
      });
    });
  }
  function setup(){
    const containers = [
      document.getElementById('volumesList'),
      document.getElementById('volumeList'),
      document.getElementById('volumesTable'),
      document.getElementById('volumeTable'),
      document.querySelector('[data-tool="volumes"]'),
      document.querySelector('[data-panel="volumes"]'),
      document.getElementById('toolsContent')
    ].filter(Boolean);
    containers.forEach(markTickersInVolumes);

    // Observe dynamic updates
    const host = document.getElementById('toolsContent') || document.body;
    const mo = new MutationObserver(()=>{
      containers.forEach(markTickersInVolumes);
    });
    mo.observe(host, {childList:true, subtree:true});
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const b1=document.getElementById('oiP_1m');
  const b5=document.getElementById('oiP_5m');
  const b15=document.getElementById('oiP_15m');
  if(b1 && !b1._oiBound){ b1.addEventListener('click', ()=>OI_setPeriod('1m')); b1._oiBound=true; }
  if(b5 && !b5._oiBound){ b5.addEventListener('click', ()=>OI_setPeriod('5m')); b5._oiBound=true; }
  if(b15 && !b15._oiBound){ b15.addEventListener('click', ()=>OI_setPeriod('15m')); b15._oiBound=true; }
});
</script>
<script>
// ===== Agent: auto-refresh every 5s with toggle; sticky open; live price coloring =====
(function(){
  const STATE = { enabled:false, timer:null, lastPrice:null, lastSym:null };
  function getAgentBox(){
    return document.getElementById('agentAdvice') ||
           document.querySelector('#agentPanel, .agent-panel, [data-role="agent"]') ||
           document.querySelector('.agent');
  }
  function getAgentInput(){
    return document.getElementById('agentSearchInput') ||
           document.querySelector('[data-role="agent-search"] input') ||
           document.querySelector('#toolsContent input[type="search"]');
  }
  function runAgentSoft(){
    const box = getAgentBox(); if (!box) return;
    // keep height to avoid flicker
    const h = box.getBoundingClientRect().height;
    box.style.minHeight = h ? (h + 'px') : box.style.minHeight;
    // remember symbol
    const inp = getAgentInput();
    STATE.lastSym = inp ? (inp.value||'').trim() : STATE.lastSym;
    // call agent
    try{ if (window.agent_panel_run) agent_panel_run(); }catch(e){}
    // update colors after re-render
    setTimeout(()=>{
      softColorize();
      // release minHeight a bit later
      setTimeout(()=>{ box.style.minHeight = ''; }, 120);
    }, 250);
  }
  function softColorize(){
    const box = getAgentBox(); if (!box) return;
    // Try common ids/classes for live price
    const priceEl = box.querySelector('#agentPrice, .agent-price, [data-field="price"], .price, .last-price');
    if (!priceEl) return;
    const txt = (priceEl.textContent||'').replace(/[^\d\.\-]/g,'');
    const val = parseFloat(txt);
    if (!isFinite(val)) return;
    if (STATE.lastPrice != null){
      const up = val > STATE.lastPrice;
      const down = val < STATE.lastPrice;
      priceEl.style.transition = 'color 0.2s ease';
      if (up){ priceEl.style.color = '#22c55e'; }      // green-500
      else if (down){ priceEl.style.color = '#ef4444'; } // red-500
    }
    STATE.lastPrice = val;
  }
  function toggleAuto(){
    STATE.enabled = !STATE.enabled;
    const btn = document.getElementById('agentAutoBtn');
    if (btn){ btn.textContent = STATE.enabled ? '–ê–≤—Ç–æ 5—Å: –í–´–ö–õ' : '–ê–≤—Ç–æ 5—Å: –í–ö–õ'; }
    if (STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; }
    if (STATE.enabled){
      runAgentSoft();
      STATE.timer = setInterval(runAgentSoft, 5000);
    }
  }
  
  function injectToggle(){
    if (document.getElementById('agentAutoBtn')) return;
    const inp = getAgentInput();
    const btn = document.createElement('button');
    btn.id = 'agentAutoBtn';
    btn.type = 'button';
    btn.className = 'btn';
    btn.textContent = '–ê–≤—Ç–æ 5—Å: –í–ö–õ';
    btn.addEventListener('click', toggleAuto, {passive:true});
    if (inp && inp.parentElement){
      inp.parentElement.appendChild(btn);
    } else {
      const box = getAgentBox();
      if (box && box.parentElement) box.parentElement.insertBefore(btn, box);
    }
  }

  }
  // Keep panel open: add sticky class (for apps –≥–¥–µ —Å–æ–≤–µ—Ç —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è)
  function keepOpen(){
    const box = getAgentBox();
    if (box){ box.classList.add('agent-sticky-open'); }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    injectToggle();
    keepOpen();
  });
  // re-attach if UI re-renders
  let tries=0; const t=setInterval(()=>{ injectToggle(); if (++tries>20) clearInterval(t); }, 300);
  // When user selects a ticker elsewhere, reset lastPrice so color compares correctly
  window.addEventListener('appSelectSymbol', ()=>{ STATE.lastPrice=null; }, {passive:true});
  // If your app calls appSelectSymbol(symbol) directly, we can hook it to dispatch the event
  if (window.appSelectSymbol && !window._agentHooked){
    const orig = window.appSelectSymbol;
    window.appSelectSymbol = function(s){
      try { window.dispatchEvent(new Event('appSelectSymbol')); }catch(e){}
      return orig.apply(this, arguments);
    };
    window._agentHooked = true;
  }
})();
</script>
<script>
// === Agent auto-refresh: 5s / 10—Å / 15—Å + Stop; —Ü–≤–µ—Ç–∞ = –∫–∞–∫ –≤ OI; –±–µ–∑ –º–∏–≥–∞–Ω–∏—è; —Å—Ç–∞—Ç–∏—á–Ω—ã–π —Ç–∏–∫–µ—Ä ===
(function(){
  const STATE = { timer:null, interval:0, lastPrice:null };

  function $(sel,root=document){ return root.querySelector(sel); }
  function getAgentInput(){ return $('#agentSearchInput') || document.querySelector('[data-role="agent-search"] input'); }
  function getAgentBox(){ return $('#agentAdvice') || $('#agentPanel') || document.querySelector('.agent-panel, [data-role="agent"], .agent'); }
  function getTickerEl(b){ return b && (b.querySelector('#agentTicker, .agent-ticker, [data-field=\"symbol\"], .symbol, .ticker')); }
  function getPriceEl(b){ return b && (b.querySelector('#agentPrice, .agent-price, [data-field=\"price\"], .price, .last-price')); }

  function lockBox(box){
    if (!box) return;
    const h = box.getBoundingClientRect().height;
    box.style.minHeight = h ? (h+'px') : box.style.minHeight;
  }
  function unlockBox(box){ if (!box) return; setTimeout(()=>{ box.style.minHeight=''; }, 120); }

  function colorizePrice(box){
    const el = getPriceEl(box); if (!el) return;
    const v = parseFloat((el.textContent||'').replace(/[^\d\.\-]/g,''));
    if (!isFinite(v)) return;
    el.style.transition = 'color .2s ease';
    if (STATE.lastPrice!=null){
      if (v > STATE.lastPrice) el.style.color = '#22c55e'; // –∑–µ–ª—ë–Ω—ã–π ‚Üë
      else if (v < STATE.lastPrice) el.style.color = '#ef4444'; // –∫—Ä–∞—Å–Ω—ã–π ‚Üì
    }
    STATE.lastPrice = v;
  }

  function runAgentSoft(){
    const box = getAgentBox(); if (!box) return;
    box.classList.add('agent-sticky-open'); // –Ω–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—Å—è
    lockBox(box);

    const tEl = getTickerEl(box);
    const snap = tEl ? {
      text: tEl.textContent,
      fontSize: getComputedStyle(tEl).fontSize,
      fontWeight: getComputedStyle(tEl).fontWeight,
      lineHeight: getComputedStyle(tEl).lineHeight,
    } : null;

    try{ if (window.agent_panel_run) agent_panel_run(); }catch(_){}

    setTimeout(()=>{
      const box2 = getAgentBox() || box;
      if (snap){
        const el2 = getTickerEl(box2);
        if (el2){
          if (el2.textContent && el2.textContent.trim() === (snap.text||'').trim()){
            el2.style.fontSize   = snap.fontSize;
            el2.style.fontWeight = snap.fontWeight;
            el2.style.lineHeight = snap.lineHeight;
          }else if (snap.text){
            // –µ—Å–ª–∏ —Ä–µ—Ä–µ–Ω–¥–µ—Ä —Å–º–µ–Ω–∏–ª —Ç–µ–∫—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–π (—Ç–∏–∫–µ—Ä —Å—Ç–∞—Ç–∏—á–µ–Ω –≤–∏–∑—É–∞–ª—å–Ω–æ)
            el2.textContent = snap.text;
            el2.style.fontSize   = snap.fontSize;
            el2.style.fontWeight = snap.fontWeight;
            el2.style.lineHeight = snap.lineHeight;
          }
        }
      }
      colorizePrice(box2);
      unlockBox(box2);
    }, 250);
  }

  function stopAuto(){
    if (STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; }
    STATE.interval = 0;
    highlightActive();
  }
  function startAuto(ms){
    stopAuto();
    STATE.interval = ms;
    runAgentSoft();
    STATE.timer = setInterval(runAgentSoft, ms);
    highlightActive();
  }

  function makeBtn(txt, ms){
    const b=document.createElement('button');
    b.className='agent-auto-btn btn btn-xs'; b.textContent=txt; b.dataset.ms = String(ms);
    b.addEventListener('click', ()=>{ if (STATE.interval===ms) stopAuto(); else startAuto(ms); });
    return b;
  }
  function makeStop(){
    const b=document.createElement('button');
    b.className='agent-auto-btn agent-auto-stop btn btn-xs'; b.textContent='‚úï';
    b.title='–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'; b.addEventListener('click', stopAuto); return b;
  }

  // –ü–æ–¥–≥–æ–Ω—è–µ–º —Å—Ç–∏–ª—å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –∫–Ω–æ–ø–∫–∏ —Ç–∞–π–º–∏–Ω–≥–∞ –≤ Open Interest
  function applyOIStyleToActive(){
    const group = document.getElementById('agentAutoGroup'); if (!group) return;
    // –ù–∞—Ö–æ–¥–∏–º —ç—Ç–∞–ª–æ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ OI
    let oiBtn = document.querySelector('#oiPanel .btn.active, #oiPanel .btn-primary, [data-oi] .btn.active');
    if (!oiBtn) oiBtn = document.querySelector('#oiPanel .btn, [data-oi] .btn');
    if (!oiBtn) return;
    const cs = getComputedStyle(oiBtn);
    group.querySelectorAll('.agent-auto-btn.active').forEach(b=>{
      b.style.backgroundColor = cs.backgroundColor;
      b.style.borderColor = cs.borderColor || 'transparent';
      b.style.color = cs.color || '#fff';
      b.style.boxShadow = 'none';
    });
  }

  function highlightActive(){
    const group = document.getElementById('agentAutoGroup'); if (!group) return;
    group.querySelectorAll('.agent-auto-btn').forEach(btn=>{
      const ms = parseInt(btn.dataset.ms||'0',10);
      if (ms){ if (STATE.interval===ms) btn.classList.add('active'); else btn.classList.remove('active'); }
      if (!ms){ btn.classList.remove('active'); }
    });
    applyOIStyleToActive();
  }

  function injectUI(){
    if (document.getElementById('agentAutoGroup')) return;
    const inp = getAgentInput(); if (!inp) return;
    // –£–¥–∞–ª–∏–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –±—ã–ª–∞
    const old = document.getElementById('agentAutoBtn'); if (old) old.remove();
    const group = document.createElement('span');
    group.id='agentAutoGroup'; group.className='agent-auto-group';
    group.appendChild(makeBtn('5—Å', 5000));
    group.appendChild(makeBtn('10—Å', 10000));
    group.appendChild(makeBtn('15—Å', 15000));
    group.appendChild(makeStop());
    inp.parentElement ? inp.parentElement.appendChild(group) : inp.after(group);
    highlightActive();
  }

  document.addEventListener('DOMContentLoaded', ()=>{ injectUI(); highlightActive(); });
  let tries=0; const t=setInterval(()=>{ injectUI(); highlightActive(); if (++tries>20) clearInterval(t); }, 300);

  // –ö–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è —Ç–∏–∫–µ—Ä —á–µ—Ä–µ–∑ appSelectSymbol ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º baseline —Ü–µ–Ω—ã
  if (window.appSelectSymbol && !window._agentAutoHookedFinal){
    const orig = window.appSelectSymbol;
    window.appSelectSymbol = function(s){ STATE.lastPrice=null; return orig.apply(this, arguments); };
    window._agentAutoHookedFinal = true;
  }
})();
</script>
<script>
// === Agent auto-refresh (5/10/15 + ‚úï): compact purple, panel always open, flash numbers only ===
(function(){
  const STATE = { timer:null, interval:0, lastPrice:null, guardOpen:true };

  function $(sel,root=document){ return root.querySelector(sel); }
  function getAgentInput(){ return $('#agentSearchInput') || document.querySelector('[data-role="agent-search"] input'); }
  function getAgentBox(){ return $('#agentAdvice') || $('#agentPanel') || document.querySelector('.agent-panel, [data-role="agent"], .agent'); }
  function getTickerEl(b){ return b && (b.querySelector('#agentTicker, .agent-ticker, [data-field=\"symbol\"], .symbol, .ticker')); }
  function getPriceEl(b){ return b && (b.querySelector('#agentPrice, .agent-price, [data-field=\"price\"], .price, .last-price')); }

  // Guard: keep panel open ‚Äî temporarily neutralize collapse while auto is on
  function guardCollapse(enable){
    STATE.guardOpen = !!enable;
    if (!window._agentCollapsePatched){
      const original = window.agent_panel_collapse;
      window.agent_panel_collapse = function(){
        if (STATE.guardOpen) return; // ignore collapse while auto enabled
        if (typeof original === 'function') return original.apply(this, arguments);
      };
      window._agentCollapsePatched = true;
    }
  }

  function lockBox(box){
    if (!box) return;
    const h = box.getBoundingClientRect().height;
    if (h) box.style.minHeight = h + 'px';
  }
  function unlockBox(box){
    if (!box) return;
    setTimeout(()=>{ box.style.minHeight = ''; }, 120);
  }

  function flash(el, cls){
    if (!el) return;
    el.classList.remove('flash-green','flash-red');
    void el.offsetWidth;
    el.classList.add(cls);
    setTimeout(()=>{ el && el.classList.remove(cls); }, 450);
  }

  function colorizePrice(box){
    const el = getPriceEl(box); if (!el) return;
    const v = parseFloat((el.textContent||'').replace(/[^\d\.\-]/g,''));
    if (!isFinite(v)) return;
    if (STATE.lastPrice!=null){
      if (v > STATE.lastPrice) flash(el, 'flash-green');
      else if (v < STATE.lastPrice) flash(el, 'flash-red');
    }
    STATE.lastPrice = v;
  }

  function runAgentSoft(){
    const box = getAgentBox(); if (!box) return;
    box.classList.add('agent-sticky-open');
    lockBox(box);

    const tEl = getTickerEl(box);
    const snap = tEl ? {
      text: tEl.textContent,
      fontSize: getComputedStyle(tEl).fontSize,
      fontWeight: getComputedStyle(tEl).fontWeight,
      lineHeight: getComputedStyle(tEl).lineHeight,
    } : null;

    try{ if (window.agent_panel_run) agent_panel_run(); }catch(_){}

    setTimeout(()=>{
      const box2 = getAgentBox() || box;
      if (snap){
        const el2 = getTickerEl(box2);
        if (el2){
          el2.textContent = snap.text || el2.textContent;
          el2.style.fontSize   = snap.fontSize;
          el2.style.fontWeight = snap.fontWeight;
          el2.style.lineHeight = snap.lineHeight;
        }
      }
      colorizePrice(box2);
      unlockBox(box2);
    }, 220);
  }

  function stopAuto(){
    if (STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; }
    STATE.interval = 0;
    guardCollapse(false);
    highlightActive();
  }
  function startAuto(ms){
    stopAuto();
    STATE.interval = ms;
    guardCollapse(true);
    runAgentSoft();
    STATE.timer = setInterval(runAgentSoft, ms);
    highlightActive();
  }

  function makeBtn(txt, ms){
    const b=document.createElement('button');
    b.className='agent-auto-btn btn btn-xs'; b.textContent=txt; b.dataset.ms = String(ms);
    b.addEventListener('click', ()=>{ if (STATE.interval===ms) stopAuto(); else startAuto(ms); });
    return b;
  }
  function makeStop(){
    const b=document.createElement('button');
    b.className='agent-auto-btn agent-auto-stop btn btn-xs'; b.textContent='‚úï';
    b.title='–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'; b.addEventListener('click', stopAuto); return b;
  }

  function highlightActive(){
    const group = document.getElementById('agentAutoGroup'); if (!group) return;
    group.querySelectorAll('.agent-auto-btn').forEach(btn=>{
      const ms = parseInt(btn.dataset.ms||'0',10);
      if (ms){ if (STATE.interval===ms) btn.classList.add('active'); else btn.classList.remove('active'); }
      if (!ms){ btn.classList.remove('active'); }
    });
  }

  function injectUI(){
    if (document.getElementById('agentAutoGroup')) return;
    const inp = getAgentInput(); if (!inp) return;
    const old = document.getElementById('agentAutoBtn'); if (old) old.remove();
    const group = document.createElement('span');
    group.id='agentAutoGroup'; group.className='agent-auto-group';
    group.appendChild(makeBtn('5—Å', 5000));
    group.appendChild(makeBtn('10—Å', 10000));
    group.appendChild(makeBtn('15—Å', 15000));
    group.appendChild(makeStop());
    if (inp.parentElement) inp.parentElement.appendChild(group); else inp.after(group);
    highlightActive();
  }

  document.addEventListener('DOMContentLoaded', ()=>{ injectUI(); });
  let tries=0; const t=setInterval(()=>{ injectUI(); highlightActive(); if (++tries>20) clearInterval(t); }, 300);

  if (window.appSelectSymbol && !window._agentAutoHookedCompact){
    const orig = window.appSelectSymbol;
    window.appSelectSymbol = function(s){ STATE.lastPrice=null; return orig.apply(this, arguments); };
    window._agentAutoHookedCompact = true;
  }
})();
</script>

  <!-- Sticky: Binance Spot ‚Äî Top 20 Gainers -->
  <aside class="spot-ticker-panel" id="spot-ticker-panel" role="dialog" aria-modal="false" aria-labelledby="spot-ticker-title">
    <header class="spot-ticker-header">
      <div class="spot-ticker-title">
        <b id="spot-ticker-title">Top 20 –ø–æ —Ä–æ—Å—Ç—É (%)</b>
        <small class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫: Binance Spot (24h)</small>
      </div><button type="button" class="spot-ticker-close" id="spot-ticker-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button> </header>
    <div class="spot-ticker-list" id="spot-ticker-list">
      <ul id="spot-ticker-ul"></ul>
    </div>
    <div class="spot-ticker-footer">
      <span id="spot-updated" class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶</span>
      <a class="link" href="https://www.binance.com/en/markets/overview" target="_blank" rel="noopener">Binance Markets</a>
    </div>
  </aside>

<script>
(function(){
  const QUOTE = "USDT";
  const LIMIT = 20;
  const REFRESH_MS = 60000;
  const EXCLUDE_REGEX = /(UP|DOWN|BULL|BEAR)/;

  const btn = document.getElementById("btn-binance-spot");
  if (btn) btn.setAttribute("aria-controls", "spot-ticker-panel");

  const panel = document.getElementById("spot-ticker-panel");
  const closeBtn = document.getElementById("spot-ticker-close");
  const list = document.getElementById("spot-ticker-ul");
  const updatedEl = document.getElementById("spot-updated");

  function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); }
  function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }

  if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
  if (closeBtn) closeBtn.addEventListener("click", closePanel);
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

  async function fetchTopGainers(){
    try {
      const resp = await fetch("https://api.binance.com/api/v3/ticker/24hr");
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      const filtered = data.filter(t =>
        t.symbol.endsWith(QUOTE) &&
        !EXCLUDE_REGEX.test(t.symbol) &&
        Number(t.quoteVolume) > 0
      );
      filtered.sort((a,b)=> Number(b.priceChangePercent) - Number(a.priceChangePercent));
      const top = filtered.slice(0, LIMIT);
      renderList(top);
      const ts = new Date(); updatedEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + ts.toLocaleString();
    } catch(e){
      console.error(e);
      updatedEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    }
  }

  function renderList(rows){
    list.innerHTML = "";
    for (const row of rows){
      const li = document.createElement("li");
      li.className = "spot-ticker-row";
      const sym = row.symbol.replace(QUOTE, "");
      const pct = Number(row.priceChangePercent);
      const symEl = document.createElement("div"); symEl.className = "sym"; symEl.textContent = sym;
      const pctEl = document.createElement("div"); pctEl.className = "pct " + (pct >= 0 ? "up" : "down"); pctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
      li.appendChild(symEl); li.appendChild(pctEl); list.appendChild(li);
    }
  }

  fetchTopGainers();
  setInterval(fetchTopGainers, REFRESH_MS);
})();
</script>

    <!-- Sticky: Bybit Spot ‚Äî Top 20 Gainers -->
    <aside class="spot-ticker-panel" id="bybit-ticker-panel" role="dialog" aria-modal="false" aria-labelledby="bybit-ticker-title" style="top:16px; right:16px;">
      <header class="spot-ticker-header">
        <div class="spot-ticker-title">
          <b id="bybit-ticker-title">Top 20 –ø–æ —Ä–æ—Å—Ç—É (%)</b>
          <small class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫: Bybit Spot (24h)</small>
        </div><button type="button" class="spot-ticker-close" id="bybit-ticker-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button> </header>
      <div class="spot-ticker-list">
        <ul id="bybit-ticker-ul"></ul>
      </div>
      <div class="spot-ticker-footer">
        <span id="bybit-updated" class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶</span>
        <a class="link" href="https://www.bybit.com/ru-RU/trade/spot/overview" target="_blank" rel="noopener">Bybit Markets</a>
      </div>
    </aside>
    

    <script>
    (function(){
      const QUOTE = "USDT";
      const LIMIT = 20;
      const REFRESH_MS = 60000;
      const EXCLUDE_REGEX = /(UP|DOWN|BULL|BEAR|3L|3S|5L|5S)/;

      const btn = document.getElementById("btn-bybit-spot");
      if (btn) btn.setAttribute("aria-controls", "bybit-ticker-panel");

      const panel = document.getElementById("bybit-ticker-panel");
      const closeBtn = document.getElementById("bybit-ticker-close");
      const list = document.getElementById("bybit-ticker-ul");
      const updatedEl = document.getElementById("bybit-updated");

      function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); }
      function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }

      if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
      if (closeBtn) closeBtn.addEventListener("click", closePanel);
      document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

      async function fetchTopGainers(){
        try {
          const url = "https://api.bybit.com/v5/market/tickers?category=spot";
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const json = await resp.json();
          const data = (json && json.result && json.result.list) ? json.result.list : [];
          const filtered = data.filter(t =>
            t.symbol && t.symbol.endsWith(QUOTE) &&
            !EXCLUDE_REGEX.test(t.symbol)
          );

          // Bybit price24hPcnt like "0.0534" = +5.34%
          filtered.sort((a,b)=> Number(b.price24hPcnt) - Number(a.price24hPcnt));
          const top = filtered.slice(0, LIMIT);
          renderList(top);
          const ts = new Date(); updatedEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + ts.toLocaleString();
        } catch(e){
          console.error(e);
          updatedEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        }
      }

      function renderList(rows){
        list.innerHTML = "";
        for (const row of rows){
          const li = document.createElement("li");
          li.className = "spot-ticker-row";
          const sym = row.symbol.replace(QUOTE, "");
          const pct = Number(row.price24hPcnt) * 100; // convert fraction to %
          const symEl = document.createElement("div"); symEl.className = "sym"; symEl.textContent = sym;
          const pctEl = document.createElement("div"); pctEl.className = "pct " + (pct >= 0 ? "up" : "down"); pctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
          li.appendChild(symEl); li.appendChild(pctEl); list.appendChild(li);
        }
      }

      fetchTopGainers();
      setInterval(fetchTopGainers, REFRESH_MS);
    })();
    </script>
    

<!-- Sticky: Bybit Futures ‚Äî Top 20 Gainers -->
<aside class="spot-ticker-panel" id="bybit-futures-panel" role="dialog" aria-modal="false" aria-labelledby="bybit-futures-title" style="top:16px; right:16px;">
  <header class="spot-ticker-header">
    <div class="spot-ticker-title">
      <b id="bybit-futures-title">Top 20 –ø–æ —Ä–æ—Å—Ç—É (%)</b>
      <small class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫: Bybit Futures (24h)</small>
    </div> </header>
  <div class="spot-ticker-list">
    <ul id="bybit-futures-ul"></ul>
  </div>
  <div class="spot-ticker-footer">
    <span id="bybit-futures-updated" class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶</span>
    <a class="link" href="https://www.bybit.com/ru-RU/trade/usdt/BTCUSDT" target="_blank" rel="noopener">Bybit Futures</a>
  </div>
</aside>

<script>
(function(){
  const QUOTE = "USDT";            // USDT-–º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–µ
  const LIMIT = 20;
  const REFRESH_MS = 60000;
  const EXCLUDE_REGEX = /(UP|DOWN|BULL|BEAR|3L|3S|5L|5S)/;

  const btn = document.getElementById("btn-bybit-futures");
  if (btn) btn.setAttribute("aria-controls", "bybit-futures-panel");

  const panel = document.getElementById("bybit-futures-panel");
  const closeBtn = document.getElementById("bybit-futures-close");
  const list = document.getElementById("bybit-futures-ul");
  const updatedEl = document.getElementById("bybit-futures-updated");

  function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); }
  function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }

  if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
  if (closeBtn) closeBtn.addEventListener("click", closePanel);
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

  async function fetchTopGainers(){
    try {
      // Bybit v5 futures (linear USDT perps)
      const url = "https://api.bybit.com/v5/market/tickers?category=linear";
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const json = await resp.json();
      const data = (json && json.result && json.result.list) ? json.result.list : [];

      const filtered = data.filter(t => {
        const sym = t.symbol || "";
        const contract = (t.contractType || "").toLowerCase();
        return sym.endsWith(QUOTE) &&
               !EXCLUDE_REGEX.test(sym) &&
               (contract.includes("perpetual") || contract === "" ); // —á–∞—â–µ –≤—Å–µ–≥–æ "LinearPerpetual"
      });

      // price24hPcnt is fraction, e.g., 0.0534 => +5.34%
      filtered.sort((a,b)=> Number(b.price24hPcnt) - Number(a.price24hPcnt));
      const top = filtered.slice(0, LIMIT);
      renderList(top);
      const ts = new Date(); updatedEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + ts.toLocaleString();
    } catch(e){
      console.error(e);
      if (updatedEl) updatedEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    }
  }

  function renderList(rows){
    list.innerHTML = "";
    for (const row of rows){
      const li = document.createElement("li");
      li.className = "spot-ticker-row";
      const sym = (row.symbol || "").replace(QUOTE, "");
      const pct = Number(row.price24hPcnt) * 100;
      const symEl = document.createElement("div"); symEl.className = "sym"; symEl.textContent = sym;
      const pctEl = document.createElement("div"); pctEl.className = "pct " + (pct >= 0 ? "up" : "down"); pctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
      li.appendChild(symEl); li.appendChild(pctEl); list.appendChild(li);
    }
  }

  fetchTopGainers();
  setInterval(fetchTopGainers, REFRESH_MS);
})();
</script>

<!-- Sticky: Spreads (from anywhere) -->

<!-- Sticky: Spreads (Futures Binance ‚Üî Bybit) -->
<aside class="spot-ticker-panel" id="spreads-panel" role="dialog" aria-modal="false" aria-labelledby="spreads-title" style="top:16px; right:16px;">
  <header class="spot-ticker-header">
    <div class="spot-ticker-title">
      <b id="spreads-title">–°–ø—Ä–µ–¥—ã —Ñ—å—é—á–µ—Ä—Å–æ–≤ (Binance ‚Üî Bybit)</b>
      <small class="muted">–ø–æ—Ä–æ–≥, % ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ Œî%</small>
    </div> <div class="flex items-center gap-2" style="padding-right:8px">
      <label class="muted" for="spreads-threshold" style="font-size:12px">–ü–æ—Ä–æ–≥:</label>
      <input id="spreads-threshold" type="number" min="0" step="0.01" value="0.10" style="width:70px; background:#0b1116; color:#e6edf3; border:1px solid #24303a; border-radius:6px; padding:4px 6px;">
      <span class="muted" style="font-size:12px">%</span>
    </div>
  </header>
  <div class="spot-ticker-list" id="spreads-list" style="padding:0; max-height: calc(100dvh - 140px);">
    <table id="spreads-table" style="width:100%; border-collapse:collapse; font-variant-numeric: tabular-nums;">
      <thead style="position:sticky; top:0; background:#0b1116; z-index:1; border-bottom:1px solid #24303a;">
        <tr>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #24303a;">–¢–∏–∫–µ—Ä</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303a;">Binance mid</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303–∞;">Bybit mid</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303a;">Œî abs</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303a;">Œî %</th>
        </tr>
      </thead>
      <tbody id="spreads-tbody"></tbody>
    </table>
  </div>
  <div class="spot-ticker-footer">
    <span id="spreads-updated" class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶</span>
    <span class="muted">USDT/USDC –ø–µ—Ä–ø–µ—Ç—É–∞–ª—ã, best bid/ask</span>
  </div>
</aside>

<script>
(function(){
  const REFRESH_MS = 3000;   // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
  const API_REFRESH_MS = 20000; // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ API-—Ñ–æ–ª–±—ç–∫–∞
  const TOKEN_RX = /([A-Z0-9]{2,10})(?:\/?(USDT|USD|USDC|FDUSD|BTC|ETH))/i;
  const VENUE_RX = /(BINANCE|BYBIT|OKX|KUCOIN|BITGET|KRAKEN|HUOBI|GATE|MEXC|BITSTAMP|DERIBIT|COINBASE)/i;
  const PRICE_RX = /([0-9]+(?:[.,][0-9]+)?)/;
  const QUOTE_NORMALIZE = {',':'.'};

  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫
  const STORE = Object.create(null);
  function putQuote(symbol, venue, price){
    symbol = symbol.toUpperCase().replace(/[^A-Z0-9]/g,'');
    venue = venue.toUpperCase();
    if (!STORE[symbol]) STORE[symbol] = {};
    STORE[symbol][venue] = {price: Number(price), ts: Date.now()};
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—É—à–∞
  window.pushQuote = function({venue, symbol, price}){
    if (!venue || !symbol || !(price>0)) return;
    putQuote(symbol, venue, price);
  };

  // DOM‚Äë–ø–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π/—Ç–µ–∫—Å—Ç–æ–≤
  function ingestFromText(){
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const now = Date.now();
    let node;
    while (node = walker.nextNode()){
      const t = node.textContent;
      if (!t || t.length < 4) continue;
      const tokenM = t.match(TOKEN_RX);
      if (!tokenM) continue;
      const venueM = t.match(VENUE_RX);
      const after = t.slice(Math.max(0, t.indexOf(tokenM[0]) + tokenM[0].length));
      const priceM = after.match(PRICE_RX);
      if (!priceM) continue;
      const price = Number((priceM[1]+'').replace(',', '.'));
      if (!(price>0)) continue;
      const symbol = (tokenM[1] + (tokenM[2] || '')).toUpperCase();
      const venue = venueM ? venueM[1].toUpperCase() : 'UNKNOWN';
      putQuote(symbol, venue, price);
    }
    // –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫–æ—Ç–∏—Ä–æ–≤–æ–∫
    for (const sym in STORE){
      for (const v in STORE[sym]){
        if (now - STORE[sym][v].ts > 180000) delete STORE[sym][v];
      }
    }
  }

  // –§–æ–ª–±—ç–∫: —Ç—è–Ω–µ–º –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ API –±–∏—Ä–∂, —á—Ç–æ–±—ã ¬´—á—Ç–æ‚Äë—Ç–æ¬ª –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –¥–∞–∂–µ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
  async function refreshApiFallback(){
    try {
      const [binBook, bybTick] = await Promise.all([
        fetch("https://api.binance.com/api/v3/ticker/bookTicker").then(r=>r.json()).catch(()=>[]),
        fetch("https://api.bybit.com/v5/market/tickers?category=spot").then(r=>r.json()).then(j=>j?.result?.list||[]).catch(()=>[])
      ]);

      // Binance
      for (const t of binBook){
        const sym = t.symbol;
        if (!sym || !/USDT$/.test(sym)) continue;
        const mid = (Number(t.askPrice)+Number(t.bidPrice))/2;
        if (mid>0) putQuote(sym, "BINANCE", mid);
      }
      // Bybit
      for (const t of bybTick){
        const sym = t.symbol;
        if (!sym || !/USDT$/.test(sym)) continue;
        const ask = Number(t.ask1Price || t.askPrice || t.ask || 0);
        const bid = Number(t.bid1Price || t.bidPrice || t.bid || 0);
        const mid = (ask+bid)/2;
        if (mid>0) putQuote(sym, "BYBIT", mid);
      }
    } catch(e){ console.warn("API fallback error", e); }
  }

  // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
  function renderTable(){
    const tbody = document.getElementById('spreads-tbody');
    if (!tbody) return;
    const rows = [];
    for (const sym in STORE){
      const venues = Object.keys(STORE[sym]);
      for (let i=0;i<venues.length;i++){
        for (let j=i+1;j<venues.length;j++){
          const va = venues[i], vb = venues[j];
          const pa = STORE[sym][va]?.price;
          const pb = STORE[sym][vb]?.price;
          if (!(pa>0 && pb>0)) continue;
          const mid = (pa + pb) / 2;
          const diffPct = Math.abs(pa - pb) / mid * 100;
          rows.push({symbol:sym, va, pa, vb, pb, diffPct});
        }
      }
    }
    rows.sort((a,b)=> b.diffPct - a.diffPct);
    tbody.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:8px 12px">${r.symbol}</td>
        <td style="padding:8px 12px">${r.va}</td>
        <td style="padding:8px 12px; text-align:right">${r.pa.toFixed(6)}</td>
        <td style="padding:8px 12px">${r.vb}</td>
        <td style="padding:8px 12px; text-align:right">${r.pb.toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right; font-weight:700">${r.diffPct.toFixed(3)}%</td>
      `;
      tbody.appendChild(tr);
    }
    const tsEl = document.getElementById('spreads-updated');
    if (tsEl) tsEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleString() + ` ‚Ä¢ —Ç–∏–∫–µ—Ä–æ–≤: ${Object.keys(STORE).length}`;
  }

  // –ú—É—Ç–∞—Ü–∏–∏ DOM (–Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è), —Ç–∞–π–º–µ—Ä—ã
  const obs = new MutationObserver(()=>{ ingestFromText(); });
  obs.observe(document.body, { childList: true, subtree: true, characterData: true });

  // –ü–µ—Ä–≤–∏—á–Ω—ã–π –∑–∞–ø—É—Å–∫
  ingestFromText(); refreshApiFallback(); renderTable();
  setInterval(()=>{ ingestFromText(); renderTable(); }, REFRESH_MS);
  setInterval(()=>{ refreshApiFallback(); }, API_REFRESH_MS);
})();
</script>

<script>
// ---- OI & Taker module (Binance only) ‚Äî current OI + Œî vs prev + taker buy/sell & total for 1m/5m/15m ----
(function(){
  if (window._oiModuleInit2) return; window._oiModuleInit2 = true;

  // State
  const STORE = Object.create(null); // OI live samples { SYMBOL: [{ts, oi}] }
  let currentPeriodMin = 5;
  let timer = null;
  const POLL_MS = 15000;   // 15s polling for OI (supports 1m deltas)
  const KEEP_MS = 3*60*60*1000;

  // Utils
  const now = ()=> Date.now();
  const minutes = n => n*60*1000;
  const fmtNum = x => {
    try{ return new Intl.NumberFormat('en-US', {maximumFractionDigits: 2}).format(x); }catch(_){ return String(x); }
  };
  const fmtSigned = x => (x>0?'+':'') + fmtNum(x);

  // Fetchers
  async function fetchOI(symbol){
    const url = `https://fapi.binance.com/fapi/v1/openInterest?symbol=${encodeURIComponent(symbol)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('OI HTTP '+r.status);
    const j = await r.json();
    const oi = Number(j.openInterest);
    if (!isFinite(oi)||oi<=0) throw new Error('Bad OI');
    return {ts: now(), oi};
  }
  function klineInterval(min){
    if (min===1) return '1m';
    if (min===5) return '5m';
    if (min===15) return '15m';
    return '5m';
  }
  async function fetchTakerVolumes(symbol, periodMin){
    const interval = klineInterval(periodMin);
    const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=${interval}&limit=1`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Klines HTTP '+r.status);
    const a = await r.json();
    if (!Array.isArray(a) || !a.length) throw new Error('No klines');
    const k = a[a.length-1];
    const totalBase = Number(k[5]);       // base asset volume
    const takerBuyBase = Number(k[9]);    // taker buy base asset volume
    const takerSellBase = Math.max(0, totalBase - takerBuyBase);
    return { buy: takerBuyBase, sell: takerSellBase, total: totalBase };
  }
  async function fetchHistBaseline(symbol, periodMin){
    // For 5/15m we can use futures/data openInterestHist (older row as baseline)
    const period = (periodMin===15?'15m':'5m');
    const url = `https://fapi.binance.com/futures/data/openInterestHist?symbol=${encodeURIComponent(symbol)}&period=${period}&limit=2`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Hist HTTP '+r.status);
    const arr = await r.json();
    if (!Array.isArray(arr)||!arr.length) throw new Error('No hist');
    const older = arr.length>=2 ? arr[arr.length-2] : arr[0];
    const oi = Number(older.sumOpenInterest || older.sumOpenInterestValue || older.openInterest || older.oi || 0);
    const ts = Date.parse(older.timestamp||older.time||older.date||Date.now()-minutes(periodMin));
    if (!isFinite(oi)||oi<=0) throw new Error('Bad hist OI');
    return {ts, oi};
  }

  // Store helpers
  function pushSample(symbol, sample){
    if (!STORE[symbol]) STORE[symbol] = [];
    STORE[symbol].push(sample);
    const cutoff = now() - KEEP_MS;
    while (STORE[symbol].length && STORE[symbol][0].ts < cutoff) STORE[symbol].shift();
  }
  function latest(symbol){
    const arr = STORE[symbol] || [];
    return arr.length ? arr[arr.length-1] : null;
  }
  function nearestAgo(symbol, msAgo){
    const arr = STORE[symbol] || [];
    if (!arr.length) return null;
    const target = now() - msAgo;
    let best=null, bestDt=Infinity;
    for (const s of arr){
      const dt = Math.abs(s.ts - target);
      if (dt<bestDt){ best=s; bestDt=dt; }
    }
    return best;
  }

  // UI
  function setSymbolLabel(symbol){
    const pill = document.getElementById('oiF_sym');
    if (pill){
      // Show like BTCUSDT (–ø–µ—Ä–ø–µ—Ç—É–∞–ª)
      pill.textContent = symbol || '‚Äî';
      pill.classList.remove('opacity-0');
    }
    // Also mirror symbol near "Open Interest (now)"
    const nowEl = document.getElementById('oiF_now');
    if (nowEl && symbol){
      nowEl.setAttribute('data-symbol', symbol);
      // prepend small label if not yet present
      if (!nowEl._labeled){
        const wrap = document.createElement('div');
        wrap.className = 'text-xs text-slate-400';
        wrap.id = 'oiF_nowSymLbl';
        nowEl.parentElement.insertBefore(wrap, nowEl);
        nowEl._labeled = true;
      }
      const lbl = document.getElementById('oiF_nowSymLbl');
      if (lbl) lbl.textContent = symbol + ' ‚Ä¢ Binance';
    }
  }

  function setPeriodLabels(){
    const buyLbl = document.getElementById('oiF_buyLbl');
    const sellLbl = document.getElementById('oiF_sellLbl');
    if (buyLbl) buyLbl.textContent = `Taker Buy (${currentPeriodMin}m)`;
    if (sellLbl) sellLbl.textContent = `Taker Sell (${currentPeriodMin}m)`;
    // Update Total label (prev sibling of #oiF_total)
    const totalEl = document.getElementById('oiF_total');
    if (totalEl && totalEl.previousElementSibling){
      totalEl.previousElementSibling.textContent = `–í—Å–µ–≥–æ (Buy+Sell, ${currentPeriodMin}m)`;
    }
    const lbl = document.getElementById('oiF_buyLbl'); // header label already set
    const hdr = document.getElementById('oiF_buyLbl'); // no extra
  }
  function setActiveButtons(){
    const ids = {1:'oiP_1m',5:'oiP_5m',15:'oiP_15m'};
    Object.entries(ids).forEach(([m,id])=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (Number(m)===currentPeriodMin) el.classList.add('active','bg-green-600/80','border-green-700');
      else el.classList.remove('active','bg-green-600/80','border-green-700');
    });
  }
  function updateTimestamp(ts){
    const tsEl = document.getElementById('oiF_ts');
    if (tsEl) tsEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date(ts).toLocaleTimeString();
  }
  function colorize(el, val){
    if (!el) return;
    el.classList.remove('text-green-400','text-red-400','text-slate-400');
    if (!isFinite(val)) el.classList.add('text-slate-400');
    else el.classList.add(val>=0?'text-green-400':'text-red-400');
  }

  async function render(symbol){
    setSymbolLabel(symbol);
    if (!symbol) return;
    setPeriodLabels(); setActiveButtons();

    // 1) Current OI + delta vs prev period baseline (absolute)
    const cur = latest(symbol);
    if (cur){
      const nowEl = document.getElementById('oiF_now');
      if (nowEl) nowEl.textContent = fmtNum(cur.oi);
      updateTimestamp(cur.ts);
    }
    let base = null;
    if (currentPeriodMin===1){
      base = nearestAgo(symbol, minutes(1));
    } else {
      base = nearestAgo(symbol, minutes(currentPeriodMin));
      if (!base){
        try{ base = await fetchHistBaseline(symbol, currentPeriodMin); }catch(_){ base=null; }
      }
    }
    const deltaEl = document.getElementById('oiF_delta');
    if (deltaEl){
      if (cur && base && isFinite(cur.oi) && isFinite(base.oi)){
        const delta = cur.oi - base.oi;
        deltaEl.textContent = fmtSigned(delta);
        colorize(deltaEl, delta);
      } else {
        deltaEl.textContent = '‚Äî';
        deltaEl.className = 'text-slate-400';
      }
    }

    // 2) Taker Buy/Sell/Total for selected period via klines
    try{
      const vol = await fetchTakerVolumes(symbol, currentPeriodMin);
      const buyEl = document.getElementById('oiF_buy');
      const buyPctEl = document.getElementById('oiF_buyPct');
      const sellEl = document.getElementById('oiF_sell');
      const sellPctEl = document.getElementById('oiF_sellPct');
      const totalEl = document.getElementById('oiF_total');

      if (buyEl) { buyEl.textContent = fmtNum(vol.buy); buyEl.className='text-green-400'; }
      if (sellEl){ sellEl.textContent = fmtNum(vol.sell); sellEl.className='text-red-400'; }
      if (totalEl){ totalEl.textContent = fmtNum(vol.total); }

      const total = vol.total>0 ? vol.total : NaN;
      const buyPct = isFinite(total) ? (vol.buy/total*100) : NaN;
      const sellPct = isFinite(total) ? (vol.sell/total*100) : NaN;
      if (buyPctEl) buyPctEl.textContent = isFinite(buyPct) ? ` ${buyPct.toFixed(1)}%` : '';
      if (sellPctEl) sellPctEl.textContent = isFinite(sellPct) ? ` ${sellPct.toFixed(1)}%` : '';

    }catch(_){
      // leave placeholders
    }
  }

  // Period buttons
  function bindButtons(){
    const b1 = document.getElementById('oiP_1m');
    const b5 = document.getElementById('oiP_5m');
    const b15= document.getElementById('oiP_15m');
    if (b1 && !b1._bound){ b1.addEventListener('click', ()=>{ currentPeriodMin=1; render(getSelected()); }); b1._bound=true; }
    if (b5 && !b5._bound){ b5.addEventListener('click', ()=>{ currentPeriodMin=5; render(getSelected()); }); b5._bound=true; }
    if (b15&& !b15._bound){ b15.addEventListener('click',()=>{ currentPeriodMin=15; render(getSelected()); }); b15._bound=true; }
  }

  function getSelected(){
    try{ if (window.state && window.state.selected) return window.state.selected; }catch(_){}
    try{
      const n = document.querySelector('[data-sym].active,[data-symbol].active');
      if (n) return n.getAttribute('data-sym') || n.getAttribute('data-symbol');
    }catch(_){}
    return null;
  }

  async function tick(){
    const sym = getSelected();
    if (!sym) return;
    try{ const s = await fetchOI(sym); pushSample(sym, s); }catch(_){}
    render(sym);
  }

  // Public
  window.OI_updateFloat = function(symbol){
    setSymbolLabel(symbol);
    // on selection change, force immediate fetch+render
    fetchOI(symbol).then(s=>{ pushSample(symbol, s); render(symbol); }).catch(()=> render(symbol));
  };

  // Init
  bindButtons();
  // show panel if hidden
  const root = document.getElementById('oiFloat');
  if (root && root.classList.contains('hidden')) root.classList.remove('hidden');
  // default to 5m buttons style
  setActiveButtons(); setPeriodLabels();

  // start
  tick();
  if (timer) clearInterval(timer);
  timer = setInterval(tick, POLL_MS);
})();
</script>

<script>
(function(){
  const btn = document.getElementById("btn-spreads");
  const panel = document.getElementById("spreads-panel");
  if (btn) btn.setAttribute("aria-controls", "spreads-panel");
  const tbody = document.getElementById("spreads-tbody");
  const updatedEl = document.getElementById("spreads-updated");
  const thrInput = document.getElementById("spreads-threshold");
  function adjustSpreadsPanelWidth(){
    const panel = document.getElementById("spreads-panel");
    const table = document.getElementById("spreads-table");
    if (!panel || !table) return;
    requestAnimationFrame(()=>{
      const desired = table.scrollWidth + 32; // padding
      const minW = 560;
      const maxW = Math.floor(window.innerWidth * 0.96);
      const w = Math.min(Math.max(desired, minW), maxW);
      panel.style.width = w + "px";
    });
  }

  // Open/close
  function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); refresh(); adjustSpreadsPanelWidth(); }
  function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }
  if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

  // Threshold persistence
  const DEF_THR = 0.10;
  function loadThr(){
    try{ const v = localStorage.getItem("spreads_thr_pct"); return v!==null ? Number(v) : DEF_THR; }catch(_){ return DEF_THR; }
  }
  function saveThr(v){ try{ localStorage.setItem("spreads_thr_pct", String(v)); }catch(_){ } }
  if (thrInput){
    const v = loadThr();
    thrInput.value = isFinite(v) ? v.toFixed(2) : DEF_THR.toFixed(2);
    thrInput.addEventListener("change", ()=>{
      const n = Number(thrInput.value);
      if (isFinite(n) && n>=0){ saveThr(n); refresh(); }
    });
  }

  const INCLUDE_QUOTES = /(USDT|USDC)$/;
  const REFRESH_MS = 60000;

  async function fetchBinanceBook(){
    const url = "https://fapi.binance.com/fapi/v1/ticker/bookTicker";
    const r = await fetch(url);
    if (!r.ok) throw new Error("Binance HTTP "+r.status);
    const arr = await r.json();
    const map = new Map();
    for (const t of arr){
      const sym = t.symbol;
      if (!INCLUDE_QUOTES.test(sym)) continue;
      const bid = Number(t.bidPrice), ask = Number(t.askPrice);
      if (!(bid>0 && ask>0)) continue;
      map.set(sym, (bid+ask)/2);
    }
    return map;
  }

  async function fetchBybitBook(){
    const url = "https://api.bybit.com/v5/market/tickers?category=linear";
    const r = await fetch(url);
    if (!r.ok) throw new Error("Bybit HTTP "+r.status);
    const j = await r.json();
    const list = (j && j.result && j.result.list) ? j.result.list : [];
    const map = new Map();
    for (const t of list){
      const sym = t.symbol;
      if (!sym || !INCLUDE_QUOTES.test(sym)) continue;
      const bid = Number(t.bid1Price || t.bidPrice || t.bid || 0);
      const ask = Number(t.ask1Price || t.askPrice || t.ask || 0);
      if (!(bid>0 && ask>0)) continue;
      map.set(sym, (bid+ask)/2);
    }
    return map;
  }

  function renderRows(rows){
    tbody.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px 12px">${r.symbol}</td>
        <td style="padding:8px 12px; text-align:right">${r.bMid.toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right">${r.yMid.toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right">${(r.yMid - r.bMid).toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right; font-weight:700" class="${r.pct>=0?'up':'down'}">${(r.pct>=0?'+':'') + r.pct.toFixed(3)}%</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function refresh(){
    if (!panel || !panel.classList.contains("open")) return;
    updatedEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶";
    try{
      const [bin, byb] = await Promise.all([fetchBinanceBook(), fetchBybitBook()]);
      const thr = thrInput ? Number(thrInput.value) || 0.10 : 0.10;
      const rows = [];
      for (const [sym, bMid] of bin.entries()){
        const yMid = byb.get(sym);
        if (!isFinite(yMid)) continue;
        const pct = (yMid - bMid) / ((yMid + bMid)/2) * 100;
        if (Math.abs(pct) < thr) continue;
        rows.push({symbol: sym, bMid, yMid, pct});
      }
      rows.sort((a,b)=> Math.abs(b.pct) - Math.abs(a.pct));
      renderRows(rows);
      updatedEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleString() + " ‚Ä¢ –ø–∞—Ä: " + rows.length + ` ‚Ä¢ –ø–æ—Ä–æ–≥: ${thr.toFixed(2)}%`;
      adjustSpreadsPanelWidth();
    }catch(e){
      console.error(e);
      updatedEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    }
  }

  setInterval(refresh, REFRESH_MS);
  window.addEventListener("resize", adjustSpreadsPanelWidth);
})();
</script>

<script>
document.addEventListener("click", (ev)=>{
  const btn = ev.target.closest(".spot-close-btn");
  if (!btn) return;
  const panel = btn.closest(".spot-ticker-panel");
  if (panel){ panel.classList.remove("open"); }
});
</script>

<!-- === NATR overlay injection start === -->
<style>
  #natr-panel{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:9998;display:none;}
  #natr-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,94vw);max-height:86vh;overflow:auto;
    background:rgba(30,41,59,.95);border:1px solid #334155;border-radius:16px;color:#e5e7eb;}
  #natr-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #334155;background:#1f2937;}
  #natr-table{width:100%;border-collapse:collapse}
  #natr-table thead, #natr-table tbody { display: block; }
  #natr-table tbody { max-height: 65vh; overflow-y: auto; }
  #natr-table thead tr, #natr-table tbody tr { display: table; width: 100%; table-layout: fixed; }
  #natr-table thead th{position:sticky;top:0;background:#1f2937;border-bottom:1px solid #334155;font-size:12px;color:#94a3b8;text-align:left;padding:10px 12px}
  #natr-table tbody td{padding:12px;border-bottom:1px solid #293448;font-size:14px;vertical-align:middle}
  #natr-close{background:#374151;border:1px solid #475569;color:#e5e7eb;border-radius:10px;padding:8px 12px;font-weight:700}
  .score-chip{background:#222844;border:1px solid #2f3a63;padding:4px 8px;border-radius:8px;font-weight:700}
  .pct-up{color:#26c281;font-weight:700} .pct-down{color:#ff5d5d;font-weight:700}
  .chip{margin-left:8px;background:#23293d;border:1px solid #2d3550;color:#9aa4b2;font-size:12px;padding:4px 8px;border-radius:999px}
</style>
<div id="natr-panel">
  <div id="natr-card">
    <div id="natr-head">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">NATR 1m / 5 ‚â• 2% ‚Äî –≤—Å–µ –º–æ–Ω–µ—Ç—ã (Bybit + Binance Futures)</h3>
        <span class="chip">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: NATR ‚Üì</span>
        <span class="chip">–ü–æ—Ä–æ–≥: 1.5%+</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="natr-refresh" class="btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="natr-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div style="padding:12px 14px">
      <div id="natr-status" style="color:#9aa4b2;font-size:12px;margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <div style="overflow:auto;max-height:75vh" class="scroll-area">
        <table id="natr-table">
          <thead>
            <tr>
              <th>–¢–∏–∫–µ—Ä</th>
              <th>–¶–µ–Ω–∞</th>
              <th>NATR 1m/5, %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const panel = document.getElementById('natr-panel');
  const btnClose = document.getElementById('natr-close');
  const btnRefresh = document.getElementById('natr-refresh');
  const tbody = document.querySelector('#natr-table tbody');
  const statusEl = document.getElementById('natr-status');

  // Try to find the existing toolbar button that shows text "NATR" and attach handler
  function bindToolbarButton(){
    const candidates = Array.from(document.querySelectorAll('button, a, .tools-btn'));
    const target = candidates.find(el => (el.textContent||'').trim().toLowerCase() === 'natr');
    if(target){ target.id = 'btn-natr'; target.addEventListener('click', openPanel); }
  }

  function openPanel(){ panel.style.display='block'; scan(); }
  btnClose.addEventListener('click', ()=> panel.style.display='none');
  btnRefresh.addEventListener('click', scan);
  window.addEventListener('load', bindToolbarButton);

  // Helpers
  function tr(high, low, prevClose){ return Math.max(high-low, Math.abs(high - prevClose), Math.abs(low - prevClose)); }
  function natrFromKlines(kl){ // kl: array of [openTime, open, high, low, close, volume, ...]
    if(!kl || kl.length < 6) return null;
    const arr = kl.map(k => ({h:+k[2], l:+k[3], c:+k[4]}));
    const trs = [];
    for(let i=1;i<6;i++){ // last 5 periods need previous close
      const prev = arr[i-1].c;
      trs.push(tr(arr[i].h, arr[i].l, prev));
    }
    const atr5 = trs.reduce((s,v)=>s+v,0) / trs.length;
    const close = arr[5].c;
    const natr = 100 * atr5 / (close || 1);
    return { atr5, natr, close };
  }

  // REST
  async function binance24h(){ const r=await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr"); return r.json(); }
  async function binanceKlines(sym){ const r=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=1m&limit=6`); return r.json(); }
  async function bybitInstruments(){ const r=await fetch("https://api.bybit.com/v5/market/instruments-info?category=linear"); return r.json(); }
  async function bybitKlines(sym){ const r=await fetch(`https://api.bybit.com/v5/market/kline?category=linear&symbol=${sym}&interval=1&limit=6`); return r.json(); }

  function excludeNonUSDT(arr){ return arr.filter(x=> (x.symbol||'').endsWith('USDT')); }

  async function scan(){
    statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ä–æ–≤‚Ä¶';
    tbody.innerHTML = '';
    try{
      // Gather symbols
      const [bin24, bybInst] = await Promise.all([binance24h(), bybitInstruments()]);
      const binSymbols = excludeNonUSDT(bin24).map(x=>x.symbol);
      const bybSymbols = (bybInst?.result?.list||[]).filter(x=>x.quoteCoin==='USDT').map(x=>x.symbol);
      const total = binSymbols.length + bybSymbols.length;

      // Fetch klines in gentle batches
      const results = [];
      let done = 0;

      async function processBin(sym){
        try{
          const kl = await binanceKlines(sym);
          const calc = natrFromKlines(kl);
          if(calc && calc.natr >= 1.5){ results.push({ticker:sym, price:calc.close, natr:calc.natr, ex:'binance'}); }
        }catch(e){}
        done++; if(done % 10 === 0) statusEl.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${done}/${total}‚Ä¶`;
      }
      async function processBybit(sym){
        try{
          const r = await bybitKlines(sym);
          const kl = r?.result?.list || [];
          const calc = natrFromKlines(kl);
          if(calc && calc.natr >= 1.5){ results.push({ticker:sym, price:calc.close, natr:calc.natr, ex:'bybit'}); }
        }catch(e){}
        done++; if(done % 10 === 0) statusEl.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${done}/${total}‚Ä¶`;
      }

      // batching
      const concurrency = 5;
      async function runPool(symbols, worker){
        let i=0;
        const workers = new Array(concurrency).fill(0).map(async ()=>{
          while(i<symbols.length){
            const sym = symbols[i++];
            await worker(sym);
          }
        });
        await Promise.all(workers);
      }

      await runPool(binSymbols, processBin);
      await runPool(bybSymbols, processBybit);

      // Sort desc by natr
      results.sort((a,b)=> b.natr - a.natr);

      // Render
      tbody.innerHTML = "";
      for(const r of results){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${r.ticker}</b></td>
          <td>${Number(r.price).toFixed(6)}</td>
          <td><span class="score-chip">${r.natr.toFixed(3)}</span></td>
        `;
        tbody.appendChild(tr);
      }
      statusEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${results.length} –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (–ø–æ—Ä–æ–≥ ‚â• 1.5%)`;
    }catch(e){
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + e;
    }
  }
})();
</script>
<!-- === NATR overlay injection end === -->

<!-- Bots panel start -->
<style>
  /* Bots popup (blue theme) */
  #bots-panel{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:9998;display:none;}
  #bots-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1200px,94vw);max-height:88vh;overflow:hidden;
    background: linear-gradient(90deg, #0b1022 0%, #12173a 100%); border:1px solid #1b2244; border-radius:16px; color:#e5e7eb; box-shadow:0 12px 30px rgba(0,0,0,0.45);}
  #bots-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #1b2244;background:rgba(255,255,255,0.02);gap:10px;flex-wrap:wrap}
  #bots-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #bots-close{background:#1a203b;border:1px solid #26305a;color:#e7eaf1;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  #bots-body{display:flex;flex-direction:column;gap:10px;padding:12px 14px; max-height: calc(88vh - 56px);}
  #bots-table-wrap{flex:1;border:1px solid #1b2244;border-radius:12px;overflow:auto;background:#0b1022; }
  table.bots-table{width:100%; border-collapse:collapse; font-size:14px;}
  table.bots-table thead th{position:sticky;top:0;background:#101635;border-bottom:1px solid #1f2750;padding:10px;text-align:left}
  table.bots-table tbody tr:nth-child(odd){background:#0c132b}
  table.bots-table tbody td{padding:10px;border-bottom:1px solid #121938}
  .pct-up{color:#26c281;font-weight:700}
  .pct-down{color:#ff5d5d;font-weight:700}
  .arrow{font-weight:900;margin-left:6px}
</style>
<div id="bots-panel" aria-hidden="true">
  <div id="bots-card" role="dialog" aria-modal="true">
    <div id="bots-head">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0">–°–∏–≥–Ω–∞–ª—ã –±–æ—Ç–æ–≤ (–∞–Ω–æ–º–∞–ª–∏–∏)</h3>
        <span style="font-size:12px;color:#9aa4b2">–∏—Å—Ç–æ—á–Ω–∏–∫–∏: SSE (Binance/Bybit) + —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–∫–∞–Ω–µ—Ä | –ø–æ—Ä–æ–≥ ‚â• 1.5%</span>
      </div>
      <div id="bots-actions">
        <button id="bots-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="bots-actions"><span id="bots-status" style="font-size:12px;color:#9aa4b2"></span></div>
    </div>
    <div id="bots-body">
      <div id="bots-table-wrap">
        <table class="bots-table" id="bots-table">
          <thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–¶–µ–Ω–∞</th><th>%</th><th>–û–∂–∏–¥–∞–Ω–∏–µ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const panel = document.getElementById('bots-panel');
  const closeBtn = document.getElementById('bots-close');
  const tbody = document.querySelector('#bots-table tbody');

  function bindBotsButton(){
    // –∏—â–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —Ç–µ–∫—Å—Ç—É "–ë–æ—Ç—ã" (–≤ –ª—é–±—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –≤–µ—Ä—Ö–Ω–µ–≥–æ —Ç—É–ª–±–∞—Ä–∞)
    const nodes = Array.from(document.querySelectorAll('button, a, .tools-btn, .btn'));
    const btn = nodes.find(el => (el.textContent||'').trim().toLowerCase() === '–±–æ—Ç—ã');
    if(btn){ btn.addEventListener('click', openPanel); }
  }
  function openPanel(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); }
  function closePanel(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); }
  closeBtn.addEventListener('click', closePanel);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanel(); });

  // helpers
  function fmtPrice(x){ const v = Number(x); return isFinite(v) ? (v<1? v.toFixed(6) : v.toFixed(4)) : String(x); }
  function fmtPct(x){ const v = Number(x); return isFinite(v) ? v.toFixed(2)+'%' : String(x); }

  function rowHtml(r){
    // r = {symbol, price, pct, dir} ; dir: 'up'|'down'
    const pctCls = (r.pct>=0) ? 'pct-up' : 'pct-down';
    const arrow = (r.dir==='up') ? '<span class="arrow" style="color:#26c281">‚ñ≤</span>' : '<span class="arrow" style="color:#ff5d5d">‚ñº</span>';
    return `<tr><td>${r.symbol}</td><td>${fmtPrice(r.price)}</td><td class="${pctCls}">${fmtPct(r.pct)}</td><td>${arrow}</td></tr>`;
  }

  function renderRows(rows){
    // filter >= 1.5% abs
    const filtered = (rows||[]).filter(r => Math.abs(Number(r.pct)||0) >= 1.5);
    // sort by abs pct desc
    filtered.sort((a,b)=> Math.abs(b.pct)-Math.abs(a.pct));
    tbody.innerHTML = filtered.map(rowHtml).join('') || `<tr><td colspan="4" style="color:#9aa4b2">–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ ‚â• 1.5%</td></tr>`;
  }

  // Public API for your data layer
  window.updateBotsTable = function(rows){ try{ renderRows(rows); }catch(e){ console.error('updateBotsTable error', e); } };
  window.pushBotSignal = function(row){
    try{
      const r = {symbol: row.symbol, price: row.price, pct: row.pct, dir: row.dir};
      if(Math.abs(Number(r.pct)||0) < 1.5) return; // ignore small
      // insert keeping sort by abs pct
      const current = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return {symbol: tds[0]?.textContent, price: parseFloat(tds[1]?.textContent), pct: parseFloat((tds[2]?.textContent||'').replace('%','')), dir: (tds[3]?.textContent||'').includes('‚ñ≤')?'up':'down'};
      });
      current.push(r);
      renderRows(current);
    }catch(e){ console.error('pushBotSignal error', e); }
  };

  // initial bind
  window.addEventListener('load', bindBotsButton);
})();
</script>
<!-- Bots panel end -->

<!-- BOTS_SSE_PATCH_v1: Binance/Bybit anomalies SSE client -->
<script>
(function(){
  // Try to hook existing panel/table from your app:
  const panel = document.getElementById('bots-panel');
  const tbody = (function(){
    const t = document.querySelector('#bots-table tbody');
    if(t) return t;
    // fallback: create if missing
    const tbl = document.createElement('table');
    tbl.id = 'bots-table'; tbl.className='bots-table';
    tbl.innerHTML = '<thead><tr><th>–ë–∏—Ä–∂–∞</th><th>–¢–∏–ø</th><th>–¢–∏–∫–µ—Ä</th><th>–¶–µ–Ω–∞</th><th>%</th><th>–û–∂–∏–¥–∞–Ω–∏–µ</th></tr></thead><tbody></tbody>';
    (panel||document.body).appendChild(tbl);
    return tbl.querySelector('tbody');
  })();

  // Button binding: text "–ë–æ—Ç—ã" or #btn-bots
  function bindBotsButton(){
    const byId = document.getElementById('btn-bots');
    if(byId){ byId.addEventListener('click', openPanel); return; }
    const nodes = Array.from(document.querySelectorAll('button, a, .tools-btn, .btn'));
    const btn = nodes.find(el => (el.textContent||'').trim().toLowerCase() === '–±–æ—Ç—ã');
    if(btn){ btn.addEventListener('click', openPanel); }
  }
  function openPanel(){ if(panel){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); } }

  // Formatting and render
  function fmtPrice(x){ const v=Number(x); return isFinite(v)? (v<1? v.toFixed(6): v.toFixed(4)) : String(x); }
  function fmtPct(x){ const v=Number(x); return isFinite(v)? v.toFixed(2)+'%': String(x); }
  function rowHtml(r){
    const pct = Number(r.pct)||0;
    const pctCls = pct >= 0 ? 'pct-up':'pct-down';
    const arrow = (r.dir==='up') ? '<span class="arrow" style="color:#26c281">‚ñ≤</span>' : '<span class="arrow" style="color:#ff5d5d">‚ñº</span>';
    return `<tr>
      <td>${r.exchange||''}</td>
      <td>${r.type||''}</td>
      <td>${r.symbol||''}</td>
      <td>${fmtPrice(r.price)}</td>
      <td class="${pctCls}">${fmtPct(pct)}</td>
      <td>${arrow}</td>
    </tr>`;
  }

  const rows = [];
  function render(){
    const filtered = rows.filter(r => Math.abs(Number(r.pct)||0) >= 1.5);
    filtered.sort((a,b)=> Math.abs(b.pct)-Math.abs(a.pct));
    tbody.innerHTML = filtered.map(rowHtml).join('') || `<tr><td colspan="6" style="color:#9aa4b2">–ù–µ—Ç —Å–≤–µ–∂–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ ‚â• 1.5%</td></tr>`;
  }

  // Public API (keep compatibility with your app)
  window.updateBotsTable = function(newRows){ rows.length=0; if(Array.isArray(newRows)) rows.push(...newRows); render(); };
  window.pushBotSignal = function(r){ rows.push(r); if(rows.length>500) rows.shift(); render(); };

  // Status helper
  const statusEl = document.getElementById('bots-status');
  function setStatus(s){ if(statusEl) statusEl.textContent = s; }

  // SSE connection
  function startSSE(){
    try{
      const base = window.BOTS_API_BASE || ''; // set like: window.BOTS_API_BASE='http://localhost:9090';
      const es = new EventSource(base + '/api/bots/stream');
      es.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          rows.push(msg); if(rows.length>500) rows.shift();
          render();
        }catch(e){ console.warn('SSE parse error', e); }
      };
      es.onerror = ()=>{ es.close(); setTimeout(startSSE, 2000); };
    }catch(e){ console.warn('SSE init error', e); }
  }

  // Init
  window.addEventListener('load', bindBotsButton);
  startSSE();
})();
</script>



<!-- Single Consent Popup (only one modal in project) -->
<div id="subPopup" class="fixed inset-0 z-[1100]" style="display:none">
  <div id="subPopupBackdrop" class="fixed inset-0" style="background:rgba(0,0,0,.65);backdrop-filter:blur(6px)"></div>
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:92vw;max-width:560px">
    <div class="card" style="background:linear-gradient(180deg,#0b1220,#0a1020);border-color:#263043;box-shadow:0 12px 40px rgba(0,0,0,.6)">
      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #263043">
        <span class="pill">–ü–æ–¥–ø–∏—Å–∫–∞ 5 USDT / –º–µ—Å—è—Ü</span><button id="subPopupRegisterBtn" class="btn" style="margin-left:10px;padding:6px 12px;border-radius:10px;background:transparent;border:1.5px solid #7c3aed;color:#cfe0ff;font-weight:800;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button> <button id="subPopupLoginBtn" class="btn" style="margin-left:8px;padding:6px 12px;border-radius:10px;background:transparent;border:1.5px solid #7c3aed;color:#cfe0ff;font-weight:800;">–í–æ–π—Ç–∏</button> 
      </div>
      <!-- Body -->
      <div style="padding:16px 16px 14px">
        <div class="text-slate-200" style="opacity:.9;margin:0 0 12px">
          –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞. –û–ø–ª–∞—Ç–∞ ‚Äî <b>5 USDT</b> –≤ –º–µ—Å—è—Ü.
          –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.
        </div>

        <label style="display:flex;gap:10px;align-items:flex-start;margin:10px 0">
          <input id="subC1" type="checkbox" style="position:relative;top:3px">
          <div><b>–Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –ø–æ–¥–ø–∏—Å–∫—É 5 USDT/–º–µ—Å</b><br>
            <span style="opacity:.75;font-size:12px">–∏ —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å <a href="#" class="text-sky-400 hover:underline">—É—Å–ª–æ–≤–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞</a> –∏ <a href="#" class="text-sky-400 hover:underline">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.</span>
          </div>
        </label>
        <label style="display:flex;gap:10px;align-items:flex-start;margin:10px 0">
          <input id="subC2" type="checkbox" style="position:relative;top:3px">
          <div>–ú–Ω–µ 18+ –ª–µ—Ç</div>
        </label>
        <label style="display:flex;gap:10px;align-items:flex-start;margin:10px 0">
          <input id="subC3" type="checkbox" style="position:relative;top:3px">
          <div>–ú–æ—è —é—Ä–∏—Å–¥–∏–∫—Ü–∏—è –¥–æ–ø—É—Å–∫–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</div>
        </label>

        <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
          <button id="subPopupContinue" class="btn"
                  style="background:transparent;border:1.5px solid #7c3aed;color:#cfe0ff;border-radius:12px;font-weight:800;opacity:.55;pointer-events:none">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
          <span style="opacity:.6;font-size:12px">‚Äì —è —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏</span>
        </div>

        <div style="opacity:.5;font-size:12px;margin-top:12px;border-top:1px dashed #263043;padding-top:8px">
          –ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const pop = document.getElementById('subPopup');
  const bd  = document.getElementById('subPopupBackdrop');
  const x   = document.getElementById('subPopupClose');
  const c1  = document.getElementById('subC1');
  const c2  = document.getElementById('subC2');
  const c3  = document.getElementById('subC3');
  const go  = document.getElementById('subPopupContinue');
  const openBtn = document.getElementById('togglePricesBtn'); // –í–•–û–î

  function setBusy(b){
    document.documentElement.style.overflow = b ? 'hidden' : '';
    document.body.style.overflow = b ? 'hidden' : '';
  }
  function open(){ if(pop){ pop.style.display='block'; setBusy(true);} }
  function close(){ if(pop){ pop.style.display='none'; setBusy(false);} }
  function refresh(){
    const ok = (c1?.checked && c2?.checked && c3?.checked);
    if (go){
      go.style.opacity = ok ? '1' : '.55';
      go.style.pointerEvents = ok ? 'auto' : 'none';
    }
  }

  openBtn?.addEventListener('click', open);
  bd?.addEventListener('click', close);
  x?.addEventListener('click', close);
  [c1,c2,c3].forEach(el => el && el.addEventListener('change', refresh));
  go?.addEventListener('click', close); // –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º

  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
  refresh();
})();
</script>

</div>
</div>

<!-- Login Ticket Popup -->
<div id="loginTicketWrap" class="fixed inset-0 z-[1200]" style="display:none">
  <div id="loginTicketOverlay" class="fixed inset-0" style="background:rgba(0,0,0,.6);backdrop-filter:blur(6px)"></div>
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:92vw;max-width:520px">
    <div class="card" style="background:linear-gradient(180deg,#0b1220,#0a1020);border-color:#263043;box-shadow:0 12px 40px rgba(0,0,0,.6)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #263043">
        <div style="font-weight:800">–í—Ö–æ–¥</div>
        <button id="loginTicketClose" class="btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å"
                style="width:36px;height:36px;border-radius:12px;background:#0e1730;border:1px solid #263043;color:#cdd6ff;font-weight:800;font-size:18px">√ó</button>
      </div>
      <div style="padding:14px">
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <button id="loginGoogle" class="btn" style="background:rgba(30,41,59,.6);border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-weight:700">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
          <button id="loginApple" class="btn" style="background:rgba(30,41,59,.6);border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-weight:700">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Apple</button>
        </div>
        <div style="color:#94a3b8;font-size:.9rem;margin:6px 0 10px">–∏–ª–∏ –ø–æ e‚Äëmail</div>
        <div id="loginEmailForm">
          <div style="margin-bottom:10px">
            <label style="display:block;font-size:.85rem;color:#cbd5e1;margin-bottom:6px">E‚Äëmail</label>
            <input type="email" placeholder="you@email.com"
                   style="width:100%;padding:10px 12px;border-radius:12px;color:#e5e7eb;background:rgba(2,6,23,.55);border:1px solid #334155;outline:none"/>
          </div></div><div style="margin-bottom:12px">
            <label style="display:block;font-size:.85rem;color:#cbd5e1;margin-bottom:6px">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   style="width:100%;padding:10px 12px;border-radius:12px;color:#e5e7eb;background:rgba(2,6,23,.55);border:1px solid #334155;outline:none"/>
          </div>
          <button id="loginSubmit" class="btn" style="width:100%;padding:12px 14px;border-radius:12px;font-weight:800;background:#7c3aed;color:#fff;border:1px solid #a78bfa">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Signup Ticket Popup (same layout as login) -->
<div id="signupTicketWrap" class="fixed inset-0 z-[1250]" style="display:none">
  <div id="signupTicketOverlay" class="fixed inset-0" style="background:rgba(0,0,0,.6);backdrop-filter:blur(6px)"></div>
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:92vw;max-width:520px">
    <div class="card" style="background:linear-gradient(180deg,#0b1220,#0a1020);border-color:#263043;box-shadow:0 12px 40px rgba(0,0,0,.6)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #263043">
        <div style="font-weight:800">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        
      </div>
      <div style="padding:14px">
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <button id="signupGoogle" class="btn" style="background:rgba(30,41,59,.6);border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-weight:700">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google</button>
          <button id="signupApple" class="btn" style="background:rgba(30,41,59,.6);border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-weight:700">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Apple</button>
        </div>
        <div style="color:#94a3b8;font-size:.9rem;margin:6px 0 10px">–∏–ª–∏ –ø–æ e‚Äëmail</div>
        <div id="signupEmailForm">
          <div style="margin-bottom:10px">
            <label style="display:block;font-size:.85rem;color:#cbd5e1;margin-bottom:6px">E‚Äëmail</label>
            <input type="email" placeholder="you@email.com"
                   style="width:100%;padding:10px 12px;border-radius:12px;color:#e5e7eb;background:rgba(2,6,23,.55);border:1px solid #334155;outline:none"/>
          </div>
          <div style="margin-bottom:12px">
            <label style="display:block;font-size:.85rem;color:#cbd5e1;margin-bottom:6px">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   style="width:100%;padding:10px 12px;border-radius:12px;color:#e5e7eb;background:rgba(2,6,23,.55);border:1px solid #334155;outline:none"/>
          </div>
          <button id="signupSubmit" class="btn" style="width:100%;padding:14px;border-radius:12px;font-weight:800;background:#7c3aed;color:#fff;border:1px solid #a78bfa">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Ticket Popup -->
<div id="paymentTicketWrap" class="fixed inset-0 z-[1300]" style="display:none">
  <div id="paymentTicketOverlay" class="fixed inset-0" style="background:rgba(0,0,0,.6);backdrop-filter:blur(6px)"></div>
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:92vw;max-width:560px">
    <div class="card" style="background:linear-gradient(180deg,#0b1220,#0a1020);border-color:#263043;box-shadow:0 12px 40px rgba(0,0,0,.6)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #263043">
        <div style="font-weight:800">–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ 5 USDT / –º–µ—Å—è—Ü</div>
        
      </div>
      <div style="padding:16px">
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <div class="btn" style="background:rgba(30,41,59,.6);border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-weight:700">–°–µ—Ç—å: <b>BSC (BEP20)</b></div>
          <div class="btn" style="background:rgba(30,41,59,.6);border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;font-weight:700">–°—É–º–º–∞: <b>5 USDT</b></div>
        </div>

        <div style="margin-bottom:10px">
          <div style="color:#cbd5e1;font-size:.9rem;margin-bottom:6px">–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="paymentAddress" value="0xBSCUSDTDEMOADDRESS123456789" readonly
                   style="flex:1;padding:10px 12px;border-radius:12px;color:#e5e7eb;background:rgba(2,6,23,.55);border:1px solid #334155;outline:none"/>
            <button id="paymentCopy" class="btn" style="padding:10px 12px;border-radius:10px;background:#334155;color:#fff">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div style="display:flex;gap:16px;align-items:center;margin:12px 0">
          <img id="paymentQR" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=0xBSCUSDTDEMOADDRESS123456789" style="width:180px;height:180px;border-radius:12px;border:1px solid #334155"/>
          <div class="text-slate-300 text-sm">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –∞–¥—Ä–µ—Å. –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —É–∫–∞–∂–∏—Ç–µ TxID/Hash.</div>
        </div>


        <div style="margin-top:12px">
          <label style="display:block;font-size:.85rem;color:#cbd5e1;margin-bottom:6px">TxID / Hash</label>
          <input id="paymentTx" placeholder="–í–≤–µ–¥–∏—Ç–µ TxID –∏–ª–∏ Hash"
                 style="width:100%;padding:10px 12px;border-radius:12px;color:#e5e7eb;background:rgba(2,6,23,.55);border:1px solid #334155;outline:none"/>
        </div>

        <button id="paymentConfirm" class="btn" style="width:100%;margin-top:14px;padding:12px 14px;border-radius:12px;font-weight:800;background:#7c3aed;color:#fff;border:1px solid #a78bfa">
          –Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)
        </button>

        <div id="paymentNote" style="color:#94a3b8;font-size:.85rem;margin-top:10px">–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π.</div>
      </div>
    </div>
  </div>
</div>

<script id="dualAuthTicketsController">
(function(){
  // Elements
  const subPopup    = document.getElementById('subPopup');
  const c1 = document.getElementById('subC1');
  const c2 = document.getElementById('subC2');
  const c3 = document.getElementById('subC3');
  const btnReg = document.getElementById('subPopupRegisterBtn');
  const btnLogin = document.getElementById('subPopupLoginBtn');
  const btnContinue = document.getElementById('subPopupContinue');
  const activePill = null;

  const signupWrap = document.getElementById('signupTicketWrap');
  const signupClose= document.getElementById('signupTicketClose');
  const signupOverlay= document.getElementById('signupTicketOverlay');
  const signupSubmit = document.getElementById('signupSubmit');

  const payWrap = document.getElementById('paymentTicketWrap');
  const payOverlay = document.getElementById('paymentTicketOverlay');
  const payClose   = document.getElementById('paymentTicketClose');
  const payConfirm = document.getElementById('paymentConfirm');
  const payAddr    = document.getElementById('paymentAddress');
  const payQR      = document.getElementById('paymentQR');
  const payNote    = document.getElementById('paymentNote');
  const payTx      = document.getElementById('paymentTx');

  // Utils
  function setDisabled(el, flag){
    if(!el) return;
    el.style.opacity = flag ? '.55' : '1';
    el.style.pointerEvents = flag ? 'none' : 'auto';
  }
  function open(el){ if(el) el.style.display='block'; }
  function close(el){ if(el) el.style.display='none'; }
  function allChecked(){ return !!(c1?.checked && c2?.checked && c3?.checked); }
  function fmtDate(ts){
    try { return new Date(ts).toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' }); }
    catch(_){ return ''; }
  }

  function refreshConsent(){
    const ok = allChecked();
    setDisabled(btnReg, !ok);
    setDisabled(btnContinue, !ok);
  }
  [c1,c2,c3].forEach(el => el && el.addEventListener('change', refreshConsent));
  refreshConsent();

  // Open signup from Register and Continue
  if (btnReg) btnReg.addEventListener('click', ()=>{ if(!allChecked()) return; close(subPopup); open(signupWrap); });
  if (btnContinue) btnContinue.addEventListener('click', ()=>{ if(!allChecked()) return; close(subPopup); open(signupWrap); });

  // On "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" => open payment
  if (signupSubmit) signupSubmit.addEventListener('click', ()=>{ close(signupWrap); 
    try{
      if(payAddr && payQR) payQR.src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(payAddr.value || '');
    }catch(_){}
    open(payWrap);
  });

  // Confirm payment => whitelist 30 days + Active until
  function setWhitelisted(days){
    const until = Date.now() + days*24*60*60*1000;
    localStorage.setItem('whitelistUntil', String(until));
    // Toast
    try{
      const banner=document.createElement('div');
      banner.style.cssText='position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#16a34a;color:#fff;padding:10px 14px;border-radius:12px;z-index:20000;box-shadow:0 10px 30px rgba(0,0,0,.4);font-weight:700';
      banner.textContent='–î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–æ ' + fmtDate(until);
      document.body.appendChild(banner); setTimeout(()=>banner.remove(), 3200);
    }catch(_){}
    // Pill in consent header
    /* activePill removed */
    // Approve user for social login (if –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    window.USER_IS_APPROVED = true;
    if (typeof window.__setApproved === 'function') window.__setApproved(true);
  }
  if (payConfirm){
    payConfirm.addEventListener('click', ()=>{
      // (mock) optional check of TxID
      const tx = (payTx?.value || '').trim();
      setWhitelisted(30);
      close(payWrap);
    });
  }

  // Restore pill on load
  (function initActivePill(){
    const s = localStorage.getItem('whitelistUntil');
    const until = s ? parseInt(s,10) : 0;
    if (until && until > Date.now() && activePill){
      activePill.style.display='inline-block';
      activePill.textContent='–ê–∫—Ç–∏–≤–Ω–æ –¥–æ ' + fmtDate(until);
      window.USER_IS_APPROVED = true;
      if (typeof window.__setApproved === 'function') window.__setApproved(true);
    }
  })();

  // Close handlers
  payOverlay && payOverlay.addEventListener('click', ()=>close(payWrap));
  payClose   && payClose.addEventListener('click', ()=>close(payWrap));
  signupOverlay && signupOverlay.addEventListener('click', ()=>close(signupWrap));
  signupClose   && signupClose.addEventListener('click', ()=>close(signupWrap));
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if (payWrap?.style.display==='block') close(payWrap);
      if (signupWrap?.style.display==='block') close(signupWrap);
    }
  });
})();
</script>


<script id="agentAutoMount">
(function(){
  function ensureAgentRunShim(){
    if (typeof window.agent_panel_run === 'function') return;
    window.agent_panel_run = async function(){
      try{
        const input = document.getElementById('agentSearchInput')
          || document.querySelector('#agentPanel input[type="text"], #agentPanel input[type="search"]')
          || document.querySelector('input[placeholder*="—Ç–∏–∫"], input[placeholder*="—Ç–∏–∫–µ—Ä"], input[placeholder*="symbol"], input[type="search"]');
        const out = document.getElementById('agentOut');
        const raw = (input && input.value || '').trim();
        if (!raw) return;
        if (typeof window.AGENT_run === 'function' && typeof window.AGENT_render === 'function'){
          const res = await window.AGENT_run(raw);
          window.AGENT_render(res);
        }
      }catch(e){ console.error('agent_panel_run shim error', e); }
    };
  }

  function makeButtons(group){
    const mk=(label,sec,cls='')=>{ const b=document.createElement('button'); b.className='agent-auto-btn '+cls; b.textContent=label; b.dataset.sec=sec; return b; };
    const b5=mk('5c',5), b10=mk('10c',10), b15=mk('15c',15), bX=mk('X',0,'stop');
    [b5,b10,b15,bX].forEach(b=>group.appendChild(b));
    let t=null;
    function setActive(btn){ [b5,b10,b15,bX].forEach(x=>x.classList.remove('active')); if(btn) btn.classList.add('active'); }
    function start(sec,btn){
      if (t) clearInterval(t); t=null;
      if (sec>0){
        setActive(btn);
        window.agent_panel_run && window.agent_panel_run();
        t = setInterval(()=> window.agent_panel_run && window.agent_panel_run(), sec*1000);
      } else {
        setActive(bX);
      }
    }
    b5.onclick = ()=> start(5,b5);
    b10.onclick= ()=> start(10,b10);
    b15.onclick= ()=> start(15,b15);
    bX.onclick  = ()=> { if(t) clearInterval(t); t=null; setActive(bX); };

    window.__agentAutoStop = ()=>{ if(t) clearInterval(t); t=null; setActive(bX); };
    window.__agentAutoStart = (sec)=>{ if(sec===5) b5.click(); else if(sec===10) b10.click(); else if(sec===15) b15.click(); else bX.click(); };
  }

  function mount(){
    // remove dock if ever exists
    const dock = document.getElementById('agentAutoDock'); if (dock) dock.remove();

    ensureAgentRunShim();

    const btn = document.getElementById('agentSearchBtn');
    const search = document.getElementById('agentSearchInput')
      || document.querySelector('#agentPanel input[type="text"], #agentPanel input[type="search"]')
      || document.querySelector('input[placeholder*="—Ç–∏–∫"], input[placeholder*="—Ç–∏–∫–µ—Ä"], input[placeholder*="symbol"], input[type="search"]');

    let group = document.getElementById('agentAutoGroup');
    if (!group){
      group = document.createElement('div');
      group.id = 'agentAutoGroup';
      group.className = 'agent-auto-group';
      if (btn && btn.parentElement){
        btn.insertAdjacentElement('afterend', group);
      } else if (search && search.parentElement){
        search.insertAdjacentElement('afterend', group);
      } else {
        // No anchor found ‚Äî gracefully skip (no floating dock)
        return;
      }
    }
    if (group.dataset.mounted === '1') return;
    makeButtons(group);
    group.dataset.mounted = '1';
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', mount);
  } else {
    mount();
  }
})();
</script>



<script>
// === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–∞–ª–æ–∫ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø–æ–¥–ø–∏—Å–∫–∞, –æ–ø–ª–∞—Ç–∞) ===
document.addEventListener('DOMContentLoaded', () => {
  const subPopup = document.getElementById('subPopup');
  const signupWrap = document.getElementById('signupTicketWrap');
  const paymentWrap = document.getElementById('paymentTicketWrap');
  const subBackdrop = document.getElementById('subPopupBackdrop');
  const signupOverlay = document.getElementById('signupTicketOverlay');
  const paymentOverlay = document.getElementById('paymentTicketOverlay');

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  [subBackdrop, signupOverlay, paymentOverlay].forEach(bg => {
    if (bg) bg.addEventListener('click', e => {
      e.stopPropagation();
      e.preventDefault();
    });
  });

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc
  window.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      e.stopPropagation();
      e.preventDefault();
    }
  });

  // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–ª–∏–∫–æ–≤ –ø–æ —Å–∞–º–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
  [subPopup, signupWrap, paymentWrap].forEach(modal => {
    if (modal) modal.addEventListener('click', e => {
      if (e.target === modal) {
        e.stopPropagation();
        e.preventDefault();
      }
    }, true);
  });

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–æ–º
  const blockScroll = () => document.body.style.overflow = 'hidden';
  const restoreScroll = () => document.body.style.overflow = '';

  // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ –∫–Ω–æ–ø–∫–µ "–í–•–û–î" –±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ–Ω
  const loginBtn = document.getElementById('togglePricesBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      blockScroll();
    });
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  window.addEventListener('registrationSuccess', () => {
    [subPopup, signupWrap, paymentWrap].forEach(m => { if (m) m.style.display = 'none'; });
    restoreScroll();
  });

  // –ü–µ—Ä–µ—Ö–æ–¥ –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
  const regBtn = document.getElementById('subPopupRegisterBtn');
  if (regBtn && signupWrap) {
    regBtn.addEventListener('click', () => {
      if (subPopup) subPopup.style.display = 'none';
      signupWrap.style.display = 'block';
      blockScroll();
    });
  }

  // –ü–µ—Ä–µ—Ö–æ–¥ –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –æ–ø–ª–∞—Ç—É
  const continueBtn = document.getElementById('subPopupContinue');
  if (continueBtn && paymentWrap) {
    continueBtn.addEventListener('click', () => {
      if (subPopup) subPopup.style.display = 'none';
      paymentWrap.style.display = 'block';
      blockScroll();
    });
  }
});
</script>


<script>
// === –ê–≤—Ç–æ–ø–æ–∫–∞–∑ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç ===
// === –ü–æ—Å–ª–µ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –æ–ø–ª–∞—Ç–∞ ===
// === –ë–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ ESC –∏ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω ===
(function(){
  if (window._autoPopupInit) return;
  window._autoPopupInit = true;

  const stop = e => { e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation)e.stopImmediatePropagation(); };

  document.addEventListener('DOMContentLoaded', () => {
    const subPopup = document.getElementById('subPopup');
    const subBackdrop = document.getElementById('subPopupBackdrop');
    const continueBtn = document.getElementById('subPopupContinue');

    const signupWrap = document.getElementById('signupTicketWrap');
    const signupOverlay = document.getElementById('signupTicketOverlay');

    const paymentWrap = document.getElementById('paymentTicketWrap');
    const paymentOverlay = document.getElementById('paymentTicketOverlay');

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ Esc –∏ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    const protectModal = (wrap, overlay) => {
      ['click','mousedown','mouseup','pointerdown','pointerup','touchstart','touchend'].forEach(type=>{
        if(overlay) overlay.addEventListener(type, stop, {capture:true});
        if(wrap) wrap.addEventListener(type,e=>{
          if(e.target===wrap) stop(e);
        },{capture:true});
      });
      ['keydown','keyup','keypress'].forEach(type=>{
        window.addEventListener(type,e=>{
          if(e.key==='Escape'||e.code==='Escape') stop(e);
        },{capture:true});
      });
    };

    protectModal(subPopup, subBackdrop);
    protectModal(signupWrap, signupOverlay);
    protectModal(paymentWrap, paymentOverlay);

    const blockScroll = ()=>document.body.style.overflow='hidden';
    const restoreScroll = ()=>document.body.style.overflow='';

    // === 1Ô∏è‚É£ –ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ===
    setTimeout(()=>{
      if(subPopup){
        subPopup.style.display='block';
        blockScroll();
      }
    }, 300000); // 5 –º–∏–Ω—É—Ç

    // === 2Ô∏è‚É£ –ü–æ—Å–ª–µ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ===
    if(continueBtn){
      continueBtn.addEventListener('click',()=>{
        if(subPopup) subPopup.style.display='none';
        if(signupWrap){
          signupWrap.style.display='block';
          blockScroll();
        }
      });
    }

    // === 3Ô∏è‚É£ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É ===
    window.addEventListener('registrationSuccess',()=>{
      if(signupWrap) signupWrap.style.display='none';
      if(paymentWrap){
        paymentWrap.style.display='block';
        blockScroll();
      }
    });

    // === 4Ô∏è‚É£ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã ‚Üí —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª–∫–∏ ===
    window.addEventListener('paymentSuccess',()=>{
      [subPopup, signupWrap, paymentWrap].forEach(m=>{ if(m) m.style.display='none'; });
      restoreScroll();
    });
  });
})();
</script>

</body>

<script id="loginDualButtonsController">
(function(){
  // Toggle this to enable Google/Apple buttons for approved users
  window.USER_IS_APPROVED = window.USER_IS_APPROVED ?? false;

  const btnLogin = document.getElementById('subPopupLoginBtn');
  const btnRegister = document.getElementById('subPopupRegisterBtn');
  const wrap = document.getElementById('loginTicketWrap');
  const overlay = document.getElementById('loginTicketOverlay');
  const btnClose = document.getElementById('loginTicketClose');
  const googleBtn = document.getElementById('loginGoogle');
  const appleBtn  = document.getElementById('loginApple');

  function setDisabled(el, flag){
    if(!el) return;
    el.style.opacity = flag ? '.55' : '1';
    el.style.pointerEvents = flag ? 'none' : 'auto';
  }
  function applyApproval(){
    const dis = !window.USER_IS_APPROVED;
    setDisabled(googleBtn, dis);
    setDisabled(appleBtn, dis);
  }
  applyApproval();

  function openLogin(){ wrap && (wrap.style.display='block'); }
  function closeLogin(){ wrap && (wrap.style.display='none'); }

  btnLogin && btnLogin.addEventListener('click', openLogin);
  btnRegister && btnRegister.addEventListener('click', ()=>{/* –æ—Å—Ç–∞—ë–º—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ç–∏–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */});
  overlay && overlay.addEventListener('click', closeLogin);
  btnClose && btnClose.addEventListener('click', closeLogin);
  window.addEventListener('keydown', e => { if(e.key==='Escape' && wrap?.style.display==='block') closeLogin(); });

  // helper to toggle approval from console if –Ω—É–∂–Ω–æ
  window.__setApproved = function(v){ window.USER_IS_APPROVED = !!v; applyApproval(); };
})();
</script>




</html>




<script>
(function(){
  const modal = document.getElementById('loginModal');
  const container = modal ? modal.querySelector('[data-mode]') : null;
  const openBtn = document.getElementById('togglePricesBtn');
  const closeBtn = document.getElementById('loginCloseBtn');
  const backdrop = document.getElementById('loginBackdrop');
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const title = document.getElementById('loginTitle');
  const submitBtn = document.getElementById('submitBtn');
  const g = document.getElementById('loginGoogle');
  const a = document.getElementById('loginApple');
  const form = document.getElementById('emailLoginForm');

  function openModal(mode='login'){
    if(!modal || !container) return;
    container.setAttribute('data-mode', mode);
    modal.classList.remove('hidden');
    setMode(mode);
  }
  function closeModal(){ if(modal) modal.classList.add('hidden'); }
  function setMode(mode){
    if(!container) return;
    container.setAttribute('data-mode', mode);
    if(mode === 'login'){
      tabLogin.classList.add('bg-purple-600','text-white');
      tabRegister.classList.remove('bg-purple-600','text-white');
      tabRegister.classList.add('text-slate-300');
      title.textContent = '–í–æ–π—Ç–∏';
      // Keep identical menu content as requested
      g.textContent = '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google';
      a.textContent = '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Apple';
      submitBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    } else {
      tabRegister.classList.add('bg-purple-600','text-white');
      tabLogin.classList.remove('bg-purple-600','text-white');
      tabLogin.classList.add('text-slate-300');
      title.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      // Keep identical menu (–Ω–µ –º–µ–Ω—è–µ–º –ø–æ–ª—è), —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ ‚Äî "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ ..."
      g.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google';
      a.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Apple';
      submitBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    }
  }

  if(openBtn) openBtn.addEventListener('click', () => { openModal('register'); try{ document.getElementById('registerConsent').style.display='block'; document.getElementById('consentContent').style.display='block'; const cs=document.getElementById('cryptoStep'); if(cs) cs.style.display='none'; }catch(e){} });
  if(closeBtn) closeBtn.addEventListener('click', closeModal);
  if(backdrop) backdrop.addEventListener('click', closeModal);
  if(tabLogin) tabLogin.addEventListener('click', () => { setMode('login'); try{ document.getElementById('registerConsent').style.display='none'; }catch(e){} });
  if(tabRegister) tabRegister.addEventListener('click', () => { setMode('register'); try{ document.getElementById('registerConsent').style.display='block'; document.getElementById('consentContent').style.display='block'; const cs=document.getElementById('cryptoStep'); if(cs) cs.style.display='none'; }catch(e){} });

  if(form){
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const mode = container ? container.getAttribute('data-mode') : 'login';
      const email = (document.getElementById('emailInput')||{}).value || '';
      if(window.toast){
        toast.success((mode==='login' ? '–í—Ö–æ–¥ (–¥–µ–º–æ): ' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–µ–º–æ): ') + email);
      } else {
        alert((mode==='login' ? '–í—Ö–æ–¥ (–¥–µ–º–æ): ' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–µ–º–æ): ') + email);
      }
      closeModal();
    });
  }

  if(g) g.addEventListener('click', () => {
    const mode = container ? container.getAttribute('data-mode') : 'login';
    alert((mode==='login' ? 'Google OAuth ‚Äî –≤—Ö–æ–¥ (–¥–µ–º–æ)' : 'Google OAuth ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–µ–º–æ)'));
    closeModal();
  });
  if(a) a.addEventListener('click', () => {
    const mode = container ? container.getAttribute('data-mode') : 'login';
    alert((mode==='login' ? 'Apple Sign‚Äëin ‚Äî –≤—Ö–æ–¥ (–¥–µ–º–æ)' : 'Apple Sign‚Äëin ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–µ–º–æ)'));
    closeModal();
  });
})();
</script>

