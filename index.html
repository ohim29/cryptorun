<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CryptoRun — офлайн-терминал (LIVE/DEMO)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--bg:#0f1116;--panel:#151822;--panel2:#1b2030;--text:#e8eef7;--muted:#9aa4b2;--accent:#4f8cff;--green:#2ecc71;--red:#ff5563;--border:#252a3a}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr;height:100vh}
  .header{grid-column:1/3;display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--border);background:var(--panel)}
  .title{font-weight:700;margin-right:auto}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--panel2);color:#cbd5e1;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .status{margin-left:8px;font-size:12px;color:#cbd5e1}
  .status .live{color:#6ee7b7} .status .demo{color:#fca5a5}
  .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:12px;overflow:auto}
  h2{margin:10px 0 8px;font-size:16px}
  .search{display:flex;gap:6px;margin-bottom:10px}
  .search input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:#1b2030;color:var(--text)}
  .search button{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer}
  .table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:8px}
  table{width:100%;border-collapse:collapse;font-size:13px;min-width:520px}
  th,td{padding:8px;text-align:left}
  tr{cursor:pointer}
  tr:hover{background:#1b2030}
  .pos{color:var(--green)} .neg{color:var(--red)}
  .cards{display:none; gap:8px}
  .card{background:var(--panel2); border:1px solid var(--border); border-radius:10px; padding:10px}
  .card .top{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
  .card .sym{font-weight:700}
  .card .pct.pos{color:var(--green)} .card .pct.neg{color:var(--red)}
  .card .meta{font-size:12px; color:#cfd8e3}
  .card button{margin-top:8px; width:100%; background:var(--accent); color:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; cursor:pointer}
  .main{display:flex;flex-direction:column;overflow:hidden}
  .bar{display:flex;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--panel)}
  .sym{font-weight:700}
  .panel{flex:1;overflow:auto;display:none}
  .panel.active{display:block}
  .chart-wrap{position:relative}
  .chart{height:60vh;min-height:420px;border:none;width:100%}
  .demochart{height:60vh;min-height:420px;border:1px dashed var(--border);width:100%;display:none;align-items:center;justify-content:center;position:relative}
  .demochart canvas{position:absolute;inset:0}
  .demo-overlay{position:absolute;right:8px;top:8px;background:rgba(0,0,0,.4);padding:6px 10px;border-radius:8px;font-size:12px;color:#fff}
  .ind-bar{display:flex;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--panel)}
  .ind-bar select, .ind-bar button{background:var(--panel2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px; min-height:40px}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--panel2);color:#fff;cursor:pointer}
  .hint{color:var(--muted);font-size:12px;margin-left:8px}
  body.sidebar-collapsed .sidebar{display:none}
  body.sidebar-collapsed .app{grid-template-columns:1fr}
  @media (max-width: 900px){
    .app{grid-template-columns:1fr; grid-template-rows:auto auto 1fr; height:auto; min-height:100vh}
    .sidebar{order:2; padding:10px}
    .main{order:3}
    .header{order:1; position:sticky; top:0; z-index:10}
    .chart,.demochart{height:52vh; min-height:360px}
    .tab{font-size:14px}
    .ind-bar{flex-wrap:wrap; gap:8px}
    .ind-bar select{flex:1; min-width:140px}
    th, td{padding:10px}
  }
  @media (max-width: 520px){
    .cards{display:grid; grid-template-columns:1fr}
    .table-wrap{display:none}
    .chart,.demochart{height:50vh; min-height:320px}
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">CryptoRun</div>
    <div class="tab active" data-tab="chart">График</div>
    <div class="tab" data-tab="signals">Сигналы</div>
    <div class="tab" data-tab="news">Новости</div>
    <div class="tab" data-tab="misc">Разное</div>
    <div class="status">Режим: <span id="mode" class="demo">DEMO</span></div>
  </div>

  <aside class="sidebar">
    <h2>Поиск монеты</h2>
    <div class="search">
      <input id="search" placeholder="BTC, ETH, SOL...">
      <button id="find">Найти</button>
    </div>

    <h2>Лидеры роста (24ч)</h2>
    <div class="cards" id="gainers_cards"></div>
    <div class="table-wrap"><table>
      <thead><tr><th>Тикер</th><th>Цена</th><th>%</th><th>Объём</th></tr></thead>
      <tbody id="gainers"></tbody>
    </table></div>

    <h2>Лидеры падения (24ч)</h2>
    <div class="cards" id="losers_cards"></div>
    <div class="table-wrap"><table>
      <thead><tr><th>Тикер</th><th>Цена</th><th>%</th><th>Объём</th></tr></thead>
      <tbody id="losers"></tbody>
    </table></div>
  </aside>

  <section class="main">
    <!-- График -->
    <div id="panel-chart" class="panel active">
      <div class="bar">Активный символ: <span id="active" class="sym">BINANCE:BTCUSDT</span>
        <button id="toggleSidebar" class="btn" style="margin-left:auto">Свернуть лидеров</button>
        <span class="hint">Панель инструментов TradingView включена</span>
      </div>
      <div class="chart-wrap">
        <!-- LIVE: TradingView iframe -->
        <iframe id="tv" class="chart" allowtransparency="true" scrolling="no"></iframe>
        <!-- DEMO: холст с псевдо-свечами -->
        <div id="demoWrap" class="demochart">
          <canvas id="demoCanvas"></canvas>
          <div class="demo-overlay">DEMO-график</div>
        </div>
      </div>

      <!-- Индикаторы (2 шт) -->
      <div class="ind-bar">
        <span>Индикаторы:</span>
        <select id="ind1">
          <option value="">нет</option>
          <option value="MASimple@tv-basicstudies">MA (Simple)</option>
          <option value="MAExp@tv-basicstudies">EMA</option>
          <option value="RSI@tv-basicstudies">RSI</option>
          <option value="MACD@tv-basicstudies">MACD</option>
        </select>
        <select id="ind2">
          <option value="">нет</option>
          <option value="MASimple@tv-basicstudies">MA (Simple)</option>
          <option value="MAExp@tv-basicstudies">EMA</option>
          <option value="RSI@tv-basicstudies">RSI</option>
          <option value="MACD@tv-basicstudies">MACD</option>
        </select>
        <button id="indReset">Сбросить</button>
        <button id="forceDemo" class="btn">Режим DEMO</button>
        <button id="forceLive" class="btn">Режим LIVE</button>
      </div>
    </div>

    <!-- Сигналы -->
    <div id="panel-signals" class="panel">
      <div style="padding:12px">
        <h2>Telegram-каналы</h2>
        <input id="tgInput" class="input" placeholder="Вставьте ссылку на TG-канал или @username">
        <button id="addTg" class="btn" style="margin-top:8px">Добавить</button>
        <ul id="tgList"></ul>
        <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
        <h3>Сигнальная панель</h3>
        <div class="signals-stream" id="signalsStream" style="max-height:140px;overflow:auto;background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:8px;font-size:13px;line-height:1.4"></div>
        <div class="signals-input" style="margin-top:8px;display:flex;gap:8px">
          <input id="signalInput" class="input" placeholder="Напишите сообщение сигнала...">
          <button id="signalSend" class="btn">Отправить</button>
        </div>
      </div>
    </div>

    <!-- Новости -->
    <div id="panel-news" class="panel">
      <div style="padding:12px">
        <h2>Новости (CryptoPanic)</h2>
        <input id="cpToken" class="input" placeholder="auth_token">
        <button id="loadNews" class="btn" style="margin-top:8px">Загрузить</button>
        <div id="newsList" style="margin-top:10px"></div>
        <div class="hint">Из файла `file://` новости могут блокироваться CORS. Запустите через локальный сервер или задеплойте.</div>
      </div>
    </div>

    <!-- Разное -->
    <div id="panel-misc" class="panel">
      <div style="padding:12px">
        <h2>Дневник трейдера</h2>
        <textarea id="journal" class="input" style="min-height:180px" placeholder="Заметки, планы, сделки..."></textarea>
        <button id="saveJournal" class="btn" style="margin-top:8px">Сохранить</button>
        <span id="savedMsg" class="hint"></span>
      </div>
    </div>
  </section>
</div>

<script>
const QUOTE="USDT";
const tv=document.getElementById('tv');
const demoWrap=document.getElementById('demoWrap');
const demoCanvas=document.getElementById('demoCanvas');
const active=document.getElementById('active');
const search=document.getElementById('search');
const findBtn=document.getElementById('find');
const ind1=document.getElementById('ind1'); const ind2=document.getElementById('ind2'); const indReset=document.getElementById('indReset');
const modeEl=document.getElementById('mode'); let liveRequested=true; let liveOk=false;

// --- Layout helpers
document.getElementById('toggleSidebar').addEventListener('click',()=>{
  const collapsed=document.body.classList.toggle('sidebar-collapsed');
  document.getElementById('toggleSidebar').textContent=collapsed?'Показать лидеров':'Свернуть лидеров';
});

// --- Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const tab=btn.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById('panel-'+tab).classList.add('active');
  });
});

// --- Status
function setMode(isLive){
  liveOk=isLive;
  modeEl.textContent=isLive?'LIVE':'DEMO';
  modeEl.className=isLive?'live':'demo';
  tv.style.display=isLive?'block':'none';
  demoWrap.style.display=isLive?'none':'flex';
}

// --- TradingView iframe
function buildTVUrl(sym, studies){
  const p=new URLSearchParams({symbol:sym, interval:'60', theme:'dark', style:'1', withdateranges:'1',
    allow_symbol_change:'0', hidesidetoolbar:'0', hidetoptoolbar:'0', details:'1', calendar:'1'});
  (studies||[]).filter(Boolean).forEach(s=>p.append('studies', s));
  return 'https://s.tradingview.com/widgetembed/?'+p.toString();
}
function loadTV(sym){
  if(!liveRequested){ setMode(false); return; }
  const url=buildTVUrl(sym, currentStudies());
  let loaded=false;
  tv.onload=()=>{ loaded=true; setMode(true); };
  tv.src=url;
  // failover after 8s
  setTimeout(()=>{ if(!loaded){ setMode(false); } }, 8000);
}

// --- DEMO chart (very simple pseudo-candles)
function drawDemo(symbol){
  active.textContent = symbol;
  const ctx=demoCanvas.getContext('2d');
  const w=demoCanvas.width=demoWrap.clientWidth;
  const h=demoCanvas.height=demoWrap.clientHeight;
  ctx.clearRect(0,0,w,h);
  // grid
  ctx.strokeStyle='#22283a'; ctx.lineWidth=1;
  for(let i=0;i<6;i++){ const y=i*h/6; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  // candles
  let x=30, step=Math.max(6, w/60), price=100;
  for(let i=0;i<100;i++){
    const open=price+(Math.random()-0.5)*4;
    const close=open+(Math.random()-0.5)*6;
    const high=Math.max(open,close)+Math.random()*5;
    const low =Math.min(open,close)-Math.random()*5;
    const y=(v)=>h-(v*2);
    const color=close>=open?'#2ecc71':'#ff5563';
    ctx.strokeStyle=color;
    ctx.beginPath(); ctx.moveTo(x, y(low)); ctx.lineTo(x, y(high)); ctx.stroke();
    ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(x, y(open)); ctx.lineTo(x, y(close)); ctx.stroke();
    ctx.lineWidth=1;
    x+=step; price=close;
  }
  // title
  ctx.fillStyle='#cbd5e1'; ctx.font='14px system-ui'; ctx.fillText('DEMO: '+symbol, 10, 18);
}

// --- Indicators
function currentStudies(){ return [ind1.value||'', ind2.value||''].filter(Boolean); }
[ind1, ind2].forEach(sel=> sel.addEventListener('change', ()=> setSymbol(active.textContent.replace('BINANCE:','').replace(QUOTE,'')) ));
indReset.addEventListener('click', ()=>{ ind1.value=''; ind2.value=''; setSymbol(active.textContent.replace('BINANCE:','').replace(QUOTE,'')); });
document.getElementById('forceDemo').addEventListener('click', ()=>{ liveRequested=false; setSymbol(active.textContent.replace('BINANCE:','').replace(QUOTE,'')); });
document.getElementById('forceLive').addEventListener('click', ()=>{ liveRequested=true; setSymbol(active.textContent.replace('BINANCE:','').replace(QUOTE,'')); });

// --- Helpers
function setSymbol(base){
  const sym = base.includes(':') ? base : `BINANCE:${base}${QUOTE}`;
  active.textContent = sym;
  if(liveRequested){ loadTV(sym); } else { setMode(false); drawDemo(sym); }
}
function fmtPrice(n){ const x=+n; if(!isFinite(x)) return '-'; return x>=1?x.toFixed(4):x.toFixed(8); }
function fmtVol(x){ x=+x||0; if(x>=1e9)return (x/1e9).toFixed(2)+'B'; if(x>=1e6)return (x/1e6).toFixed(2)+'M'; if(x>=1e3)return (x/1e3).toFixed(1)+'K'; return x.toFixed(0); }
function isLeveraged(s){ return /UPUSDT$|DOWNUSDT$|[0-9]+SUSDT$|[0-9]+LUSDT$|BULL|BEAR/.test(s); }

// --- Leaders (tries LIVE, else DEMO dataset)
async function loadMovers(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/24hr', {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const d=await r.json();
    buildLists(d);
  }catch(e){
    // DEMO dataset
    const demo=[
      {symbol:'BTCUSDT', lastPrice:'65000', priceChangePercent:'2.5', quoteVolume:'25000000000'},
      {symbol:'ETHUSDT', lastPrice:'3200', priceChangePercent:'-1.8', quoteVolume:'12000000000'},
      {symbol:'SOLUSDT', lastPrice:'150', priceChangePercent:'5.2', quoteVolume:'3500000000'},
      {symbol:'XRPUSDT', lastPrice:'0.56', priceChangePercent:'-3.1', quoteVolume:'900000000'},
      {symbol:'DOGEUSDT', lastPrice:'0.14', priceChangePercent:'1.1', quoteVolume:'1100000000'},
      {symbol:'BNBUSDT', lastPrice:'540', priceChangePercent:'-0.9', quoteVolume:'2100000000'},
      {symbol:'ADAUSDT', lastPrice:'0.46', priceChangePercent:'4.7', quoteVolume:'700000000'},
      {symbol:'LINKUSDT', lastPrice:'15.8', priceChangePercent:'-2.2', quoteVolume:'500000000'},
      {symbol:'AVAXUSDT', lastPrice:'38.4', priceChangePercent:'3.9', quoteVolume:'420000000'},
      {symbol:'APTUSDT', lastPrice:'6.9', priceChangePercent:'-4.0', quoteVolume:'180000000'},
      {symbol:'ARBUSDT', lastPrice:'1.05', priceChangePercent:'6.2', quoteVolume:'220000000'},
      {symbol:'OPUSDT', lastPrice:'2.1', priceChangePercent:'-5.1', quoteVolume:'150000000'}
    ];
    buildLists(demo);
  }
}
function buildLists(d){
  const rows=d.filter(x=>x.symbol && x.symbol.endsWith(QUOTE) && !isLeveraged(x.symbol))
    .map(x=>({symbol:x.symbol, price:+x.lastPrice, pct:+x.priceChangePercent, vol:+(x.quoteVolume||0)}));
  const gainers=rows.filter(r=>r.pct>0).sort((a,b)=>b.pct-a.pct).slice(0,20);
  const losers =rows.filter(r=>r.pct<0).sort((a,b)=>a.pct-b.pct).slice(0,20);
  render('gainers', gainers); render('losers', losers);
  renderCards('gainers_cards', gainers); renderCards('losers_cards', losers);
}
function render(id, arr){
  const tb=document.getElementById(id); tb.innerHTML='';
  arr.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.symbol}</td><td>${fmtPrice(r.price)}</td>
      <td class="${r.pct>=0?'pos':'neg'}">${r.pct.toFixed(2)}%</td><td>${fmtVol(r.vol)}</td>`;
    tr.addEventListener('click', ()=> setSymbol(r.symbol.replace(QUOTE,'')));
    tb.appendChild(tr);
  });
}
function renderCards(id, arr){
  const wrap=document.getElementById(id); if(!wrap) return;
  wrap.innerHTML='';
  arr.forEach(r=>{
    const div=document.createElement('div'); div.className='card';
    const pctClass=r.pct>=0?'pos':'neg';
    div.innerHTML=`<div class="top"><div class="sym">${r.symbol}</div><div class="pct ${pctClass}">${r.pct.toFixed(2)}%</div></div>
      <div class="meta">Цена: ${fmtPrice(r.price)} • Объём: ${fmtVol(r.vol)}</div>
      <button type="button">Показать на графике</button>`;
    div.querySelector('button').addEventListener('click', ()=> setSymbol(r.symbol.replace(QUOTE,'')));
    wrap.appendChild(div);
  });
}

// --- Signals (local)
const TG_KEY='tg_links_v1';
function loadTG(){
  const ul=document.getElementById('tgList');
  const list=JSON.parse(localStorage.getItem(TG_KEY)||'[]'); ul.innerHTML='';
  list.forEach((url,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<a href="${url}" target="_blank" rel="noopener">${url}</a>
      <span style="float:right;cursor:pointer;color:#91a2b5" title="Удалить" data-i="${i}">✕</span>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll('span[title="Удалить"]').forEach(span=>{
    span.addEventListener('click', ()=>{
      const idx=+span.dataset.i; const arr=JSON.parse(localStorage.getItem(TG_KEY)||'[]');
      arr.splice(idx,1); localStorage.setItem(TG_KEY, JSON.stringify(arr)); loadTG();
    });
  });
}
document.getElementById('addTg').addEventListener('click', ()=>{
  const inp=document.getElementById('tgInput'); const v=inp.value.trim(); if(!v) return;
  const normalized=v.startsWith('http')?v:('https://t.me/'+v.replace(/^@/,'').trim());
  const arr=JSON.parse(localStorage.getItem(TG_KEY)||'[]'); arr.unshift(normalized);
  localStorage.setItem(TG_KEY, JSON.stringify(arr.slice(0,100))); inp.value=''; loadTG();
});
// Signal stream
function pushSignal(text){
  if(!text) return;
  const stream=document.getElementById('signalsStream'); if(!stream) return;
  const d=new Date(); const pad=n=>String(n).padStart(2,'0');
  const t=`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const div=document.createElement('div'); div.className='msg';
  div.innerHTML=`<span class="time" style="color:#9aa4b2;margin-right:6px">${t}</span>${text}`;
  stream.appendChild(div); stream.scrollTop=stream.scrollHeight;
}
const signalInput=document.getElementById('signalInput'); const signalSend=document.getElementById('signalSend');
signalSend.addEventListener('click', ()=>{ const v=signalInput.value.trim(); if(!v) return; pushSignal(v); signalInput.value=''; });
signalInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ signalSend.click(); }});

// --- News (best-effort; may hit CORS from file://)
document.getElementById('loadNews').addEventListener('click', async ()=>{
  const token=document.getElementById('cpToken').value.trim(); if(!token){ alert('Укажите auth_token'); return; }
  const listEl=document.getElementById('newsList'); listEl.textContent='Загрузка...';
  try{
    const url=`https://cryptopanic.com/api/v1/posts/?auth_token=${encodeURIComponent(token)}&kind=news&public=true&filter=hot`;
    const res=await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status);
    const json=await res.json(); listEl.innerHTML='';
    (json.results||[]).slice(0,50).forEach(it=>{
      const div=document.createElement('div'); div.style.marginBottom='8px';
      div.innerHTML=`<a href="${it.url}" target="_blank" rel="noopener">${it.title||it.domain||'Новость'}</a>
        <div class="hint">${it.domain||''} • ${new Date(it.published_at).toLocaleString()}</div>`;
      listEl.appendChild(div);
    });
  }catch(e){ listEl.innerHTML='<span style="color:#ff8b8b">Не удалось загрузить (CORS). Откройте через локальный сервер или задеплойте.</span>'; }
});

// --- Journal
const JRN_KEY='trader_journal_v1';
const journal=document.getElementById('journal');
document.getElementById('saveJournal').addEventListener('click', ()=>{
  localStorage.setItem(JRN_KEY, journal.value);
  const s=document.getElementById('savedMsg'); s.textContent='Сохранено'; setTimeout(()=>s.textContent='', 1500);
});
journal.value=localStorage.getItem(JRN_KEY)||'';

// --- Search
document.getElementById('find').addEventListener('click', ()=>{
  const v=search.value.trim().toUpperCase(); if(!v) return;
  setSymbol(v);
  pushSignal('Поиск: <b>'+v+'</b>');
});
search.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ document.getElementById('find').click(); }});

// --- Init
(function init(){
  setMode(false); // show DEMO immediately; LIVE switches on when iframe loads
  setSymbol('BTC');
  loadMovers();
  loadTG();
  setInterval(loadMovers, 120000);
})();
</script>
</body>
</html>
